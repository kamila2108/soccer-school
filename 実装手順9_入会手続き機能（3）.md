# 入会手続き機能（3） 実装手順（初心者向け）

## 📚 このガイドについて

このガイドは、**2/14（土）: 入会手続き機能（3）＋時間予約機能の準備**の作業を初心者の方でも理解できるように、**用語の説明**や**各ステップの詳細**を丁寧に記載しています。

**所要時間**: 約4〜5時間（初めての場合）

---

## 📖 用語集（最初に読んでおくと理解が深まります）

### 入会承認・却下に関する用語

- **承認**: 管理者が入会申込みを承認すること。承認されると、ユーザーは正式な会員になります
- **却下**: 管理者が入会申込みを却下すること。却下する場合は、理由を入力する必要があります
- **ステータス**: 申込みの状態。`pending`（未確認）、`approved`（承認）、`rejected`（却下）のいずれか
- **却下理由**: 申込みを却下する理由。ユーザーに通知される内容です

### 通知機能に関する用語

- **通知**: ユーザーに重要な情報を伝える仕組み。例：入会承認通知、却下通知
- **通知テーブル**: 通知情報を保存するデータベースのテーブル（`notifications`）
- **既読フラグ**: ユーザーが通知を読んだかどうかを示すフラグ（`is_read`）
- **通知種別**: 通知の種類。例：`APPLICATION_STATUS`（入会申込みステータス）

### データベース操作に関する用語

- **UPDATE**: データベースの既存のレコードを更新する操作
- **トランザクション**: 複数のデータベース操作を1つの処理として実行する仕組み。すべて成功するか、すべて失敗するかのどちらか

---

## 📋 今日（2/14）の作業内容

開発スケジュールの「2/14（土）: 入会手続き機能（3）＋時間予約機能の準備」を完了するためのステップバイステップガイドです。

**目標**: 管理者が入会申込みを承認・却下できるようにし、ユーザーに通知を送信できる状態にする

**作成・更新するもの**:
1. 承認処理の実装（承認ボタンの動作）
2. 却下処理の実装（却下ボタンと理由入力）
3. 通知送信機能の実装（基本）
4. （余力があれば）時間予約機能の準備

---

## ✅ ステップ1: 承認処理の実装

### 1-1. 承認処理とは？

**承認処理**: 管理者が入会申込みを承認する処理です。承認されると、申込みのステータスが`pending`から`approved`に変更されます。

**処理の流れ**:
1. 管理者が申込み詳細ページで「承認する」ボタンをクリック
2. 確認ダイアログを表示
3. 承認処理を実行（データベースのステータスを更新）
4. ユーザーに通知を送信
5. 成功メッセージを表示

---

### 1-2. 承認処理のAPI Routeの作成

**目的**: 申込みを承認する処理をサーバー側で実行するためのAPI Routeを作成します。

**手順**:

1. **API Routeファイルを更新**
   - `frontend/app/api/applications/[id]/route.ts` を開く
   - 既存の`GET`関数に加えて、`PATCH`関数を追加

2. **以下のコードを追加**

```typescript
export async function PATCH(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> | { id: string } }
) {
  try {
    // セッション情報を取得
    const session = await auth()
    
    if (!session?.user?.dbId) {
      return NextResponse.json(
        { error: 'ログインが必要です' },
        { status: 401 }
      )
    }

    // TODO: 管理者権限のチェック（後で実装）
    // 現時点では、ログインしていれば全員がアクセス可能

    // Next.js 15ではparamsがPromiseになる可能性があるため、awaitする
    const resolvedParams = await Promise.resolve(params)
    const applicationId = resolvedParams.id

    // リクエストボディからアクションを取得
    const body = await request.json()
    const { action, rejectedReason } = body

    // 申込み情報を取得
    const { data: application, error: fetchError } = await supabaseAdmin
      .from('applications')
      .select('*')
      .eq('id', applicationId)
      .single()

    if (fetchError || !application) {
      return NextResponse.json(
        { error: '申込みが見つかりません' },
        { status: 404 }
      )
    }

    // ステータスがpendingでない場合はエラー
    if (application.status !== 'pending') {
      return NextResponse.json(
        { error: 'この申込みは既に処理済みです' },
        { status: 400 }
      )
    }

    if (action === 'approve') {
      // 承認処理
      const { data: updatedApplication, error: updateError } = await supabaseAdmin
        .from('applications')
        .update({ status: 'approved' })
        .eq('id', applicationId)
        .select()
        .single()

      if (updateError) {
        console.error('承認処理エラー:', updateError)
        return NextResponse.json(
          { error: '承認処理に失敗しました' },
          { status: 500 }
        )
      }

      // 通知を作成
      const { error: notificationError } = await supabaseAdmin
        .from('notifications')
        .insert({
          user_id: application.user_id,
          type: 'APPLICATION_STATUS',
          title: '入会申込みが承認されました',
          message: `お子さま（${application.name}）の入会申込みが承認されました。入会手続きのご案内をお送りします。`,
        })

      if (notificationError) {
        console.error('通知作成エラー:', notificationError)
        // 通知の作成に失敗しても、承認処理は成功として扱う
      }

      return NextResponse.json({
        success: true,
        application: updatedApplication,
      })
    } else if (action === 'reject') {
      // 却下処理（次のステップで実装）
      if (!rejectedReason || rejectedReason.trim() === '') {
        return NextResponse.json(
          { error: '却下理由を入力してください' },
          { status: 400 }
        )
      }

      const { data: updatedApplication, error: updateError } = await supabaseAdmin
        .from('applications')
        .update({
          status: 'rejected',
          rejected_reason: rejectedReason,
        })
        .eq('id', applicationId)
        .select()
        .single()

      if (updateError) {
        console.error('却下処理エラー:', updateError)
        return NextResponse.json(
          { error: '却下処理に失敗しました' },
          { status: 500 }
        )
      }

      // 通知を作成
      const { error: notificationError } = await supabaseAdmin
        .from('notifications')
        .insert({
          user_id: application.user_id,
          type: 'APPLICATION_STATUS',
          title: '入会申込みについて',
          message: `お子さま（${application.name}）の入会申込みについて、以下の理由によりお受けできませんでした。\n\n${rejectedReason}`,
        })

      if (notificationError) {
        console.error('通知作成エラー:', notificationError)
        // 通知の作成に失敗しても、却下処理は成功として扱う
      }

      return NextResponse.json({
        success: true,
        application: updatedApplication,
      })
    } else {
      return NextResponse.json(
        { error: '不正なアクションです' },
        { status: 400 }
      )
    }
  } catch (error) {
    console.error('申込み処理エラー:', error)
    return NextResponse.json(
      { error: '処理中にエラーが発生しました' },
      { status: 500 }
    )
  }
}
```

**コードの説明**:
- `PATCH`: データを更新するためのHTTPリクエスト
- `action`: 承認（`approve`）または却下（`reject`）を指定
- `rejectedReason`: 却下する場合の理由
- ステータスを`approved`または`rejected`に更新
- 通知テーブルに通知を追加

**現在の状態**: ✅ 承認・却下処理のAPI Routeが作成されました

---

### 1-3. 承認ボタンの実装

**目的**: 申込み詳細ページの「承認する」ボタンをクリックした時に、承認処理を実行します。

**手順**:

1. **申込み詳細ページを開く**
   - `frontend/app/admin/applications/[id]/page.tsx` を開く

2. **承認処理の関数を追加**

既存のコードに、以下の関数を追加します：

```typescript
const [isProcessing, setIsProcessing] = useState(false)
const [processError, setProcessError] = useState<string | null>(null)

const handleApprove = async () => {
  if (!confirm('この申込みを承認しますか？')) {
    return
  }

  setIsProcessing(true)
  setProcessError(null)

  try {
    const response = await fetch(`/api/applications/${applicationId}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        action: 'approve',
      }),
    })

    const data = await response.json()

    if (!response.ok) {
      throw new Error(data.error || '承認処理に失敗しました')
    }

    // 成功した場合、ページを再読み込み
    alert('承認処理が完了しました')
    fetchApplication() // 申込み情報を再取得
  } catch (error) {
    console.error('承認エラー:', error)
    setProcessError(error instanceof Error ? error.message : '承認処理に失敗しました')
  } finally {
    setIsProcessing(false)
  }
}
```

3. **「承認する」ボタンを更新**

既存の「承認する」ボタンの`onClick`を更新します：

```typescript
<Button
  variant="secondary"
  onClick={handleApprove}
  disabled={application.status !== 'pending' || isProcessing}
>
  {isProcessing ? '処理中...' : '承認する'}
</Button>
```

4. **エラーメッセージの表示を追加**

ボタンの下にエラーメッセージを表示します：

```typescript
{processError && (
  <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
    <p className="text-sm text-red-600">{processError}</p>
  </div>
)}
```

**コードの説明**:
- `handleApprove`: 承認処理を実行する関数
- `confirm()`: 確認ダイアログを表示
- `fetchApplication()`: 申込み情報を再取得して、最新の状態を表示

**現在の状態**: ✅ 承認ボタンが動作するようになりました

---

## ✅ ステップ2: 却下処理の実装

### 2-1. 却下処理とは？

**却下処理**: 管理者が入会申込みを却下する処理です。却下する場合は、理由を入力する必要があります。却下されると、申込みのステータスが`pending`から`rejected`に変更され、却下理由が保存されます。

---

### 2-2. 却下理由入力モーダルの作成

**目的**: 却下する際に、理由を入力するためのモーダル（ポップアップ）を作成します。

**手順**:

1. **申込み詳細ページを開く**
   - `frontend/app/admin/applications/[id]/page.tsx` を開く

2. **却下理由入力の状態を追加**

```typescript
const [showRejectModal, setShowRejectModal] = useState(false)
const [rejectedReason, setRejectedReason] = useState('')
```

3. **却下処理の関数を追加**

```typescript
const handleReject = async () => {
  if (!rejectedReason.trim()) {
    alert('却下理由を入力してください')
    return
  }

  setIsProcessing(true)
  setProcessError(null)

  try {
    const response = await fetch(`/api/applications/${applicationId}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        action: 'reject',
        rejectedReason: rejectedReason.trim(),
      }),
    })

    const data = await response.json()

    if (!response.ok) {
      throw new Error(data.error || '却下処理に失敗しました')
    }

    // 成功した場合、モーダルを閉じてページを再読み込み
    setShowRejectModal(false)
    setRejectedReason('')
    alert('却下処理が完了しました')
    fetchApplication() // 申込み情報を再取得
  } catch (error) {
    console.error('却下エラー:', error)
    setProcessError(error instanceof Error ? error.message : '却下処理に失敗しました')
  } finally {
    setIsProcessing(false)
  }
}
```

4. **却下モーダルコンポーネントを追加**

```typescript
{showRejectModal && (
  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
      <h3 className="text-xl font-semibold mb-4">却下理由を入力</h3>
      <textarea
        className="w-full border border-gray-300 rounded-md px-3 py-2 mb-4"
        rows={5}
        value={rejectedReason}
        onChange={(e) => setRejectedReason(e.target.value)}
        placeholder="却下理由を入力してください"
      />
      <div className="flex gap-3">
        <Button
          variant="secondary"
          onClick={() => {
            setShowRejectModal(false)
            setRejectedReason('')
          }}
          className="flex-1"
        >
          キャンセル
        </Button>
        <Button
          onClick={handleReject}
          disabled={isProcessing || !rejectedReason.trim()}
          className="flex-1"
        >
          {isProcessing ? '処理中...' : '却下する'}
        </Button>
      </div>
    </div>
  </div>
)}
```

5. **「却下する」ボタンを更新**

既存の「却下する」ボタンの`onClick`を更新します：

```typescript
<Button
  variant="secondary"
  onClick={() => setShowRejectModal(true)}
  disabled={application.status !== 'pending' || isProcessing}
>
  却下する
</Button>
```

**コードの説明**:
- `showRejectModal`: モーダルの表示/非表示を管理
- `rejectedReason`: 却下理由を保存
- モーダル: 固定位置で表示されるポップアップ

**現在の状態**: ✅ 却下ボタンと理由入力モーダルが動作するようになりました

---

## ✅ ステップ3: 通知送信機能の実装（基本）

### 3-1. 通知機能とは？

**通知機能**: ユーザーに重要な情報を伝える仕組みです。承認・却下処理が完了した際に、ユーザーに通知を送信します。

**通知の種類**:
- 入会承認通知: 申込みが承認されたことを伝える
- 入会却下通知: 申込みが却下されたことと理由を伝える

---

### 3-2. 通知テーブルの確認

**目的**: 通知を保存するためのテーブルが正しく作成されているか確認します。

**手順**:

1. **Supabase Dashboardを開く**
   - https://supabase.com/dashboard にアクセス
   - プロジェクトを選択

2. **Table Editorを開く**
   - 左側のメニューから「Table Editor」をクリック
   - `notifications`テーブルを選択

3. **テーブル構造を確認**
   - 以下のカラムが存在することを確認：
     - `id` (uuid, 主キー)
     - `user_id` (uuid, 外部キー → users.id)
     - `type` (text, 必須)
     - `title` (text, 必須)
     - `message` (text, 必須) または `content` (text, 必須)
     - `is_read` (boolean, デフォルト: false)
     - `created_at` (timestamptz)

**現在の状態**: ✅ 通知テーブルの構造を確認しました

---

### 3-3. 通知送信処理の確認

**目的**: 承認・却下処理で通知が正しく送信されているか確認します。

**手順**:

1. **API Routeを確認**
   - `frontend/app/api/applications/[id]/route.ts` の`PATCH`関数を確認
   - 通知作成処理が含まれていることを確認

2. **通知テーブルを確認**
   - 承認・却下処理を実行後、Supabase Dashboardで`notifications`テーブルを確認
   - 新しい通知が追加されていることを確認

**現在の状態**: ✅ 通知送信機能が実装されました（承認・却下処理と同時に通知が作成されます）

---

## ✅ ステップ4: 動作確認

### 4-1. 開発サーバーの起動

**手順**:

1. **開発サーバーを起動**
   ```bash
   cd frontend
   npm run dev
   ```

2. **起動を確認**
   - `- Local: http://localhost:3000` と表示されれば成功

---

### 4-2. 承認処理の確認

**手順**:

1. **管理者側の申込み詳細ページにアクセス**
   - ブラウザで `http://localhost:3000/admin/applications` にアクセス
   - ログインが必要な場合は、先にログインしてください
   - 未確認（`pending`）の申込みを選択して「詳細を見る」をクリック

2. **承認ボタンをクリック**
   - 「承認する」ボタンをクリック
   - 確認ダイアログが表示されることを確認
   - 「OK」をクリック

3. **承認処理の確認**
   - 成功メッセージが表示されることを確認
   - ステータスが「承認」に変更されることを確認
   - ボタンが無効化されることを確認

4. **通知の確認**
   - Supabase Dashboardで`notifications`テーブルを確認
   - 新しい通知が追加されていることを確認

---

### 4-3. 却下処理の確認

**手順**:

1. **未確認の申込みを選択**
   - 管理者側の申込み詳細ページで、未確認（`pending`）の申込みを選択

2. **却下ボタンをクリック**
   - 「却下する」ボタンをクリック
   - 却下理由入力モーダルが表示されることを確認

3. **却下理由を入力**
   - 却下理由を入力
   - 「却下する」ボタンをクリック

4. **却下処理の確認**
   - 成功メッセージが表示されることを確認
   - ステータスが「却下」に変更されることを確認
   - 却下理由が表示されることを確認
   - ボタンが無効化されることを確認

5. **通知の確認**
   - Supabase Dashboardで`notifications`テーブルを確認
   - 却下通知が追加されていることを確認
   - 却下理由が通知メッセージに含まれていることを確認

---

## ✅ ステップ5: （余力があれば）時間予約機能の準備

### 5-1. 練習枠データモデルの整理

**目的**: 時間予約機能で使用する練習枠のデータモデルを整理します。

**手順**:

1. **データモデルの確認**
   - `backend/prisma/schema.prisma` または `実装手順2_データベース設計・構築.md` を確認
   - `practice_slots`テーブルの構造を確認

2. **必要な情報の整理**
   - 練習日（`practice_date`）
   - 開始時間（`start_time`）
   - 終了時間（`end_time`）
   - 定員（`capacity`）
   - 現在の予約数（`current_reservations`）
   - ステータス（`status`）

**現在の状態**: ✅ 練習枠データモデルを確認しました

---

### 5-2. 画面ラフ・UIイメージの作成

**目的**: 時間予約機能の画面イメージを作成します。

**手順**:

1. **必要な画面を整理**
   - 練習枠一覧ページ
   - 練習枠詳細ページ
   - 予約確認ページ
   - 予約一覧ページ（会員向け）

2. **画面イメージを作成**
   - 紙に手書きでラフを作成
   - または、Figmaなどのデザインツールで作成
   - 各画面に必要な要素を整理

**現在の状態**: ✅ 画面ラフ・UIイメージを作成しました

---

## ✅ 完了チェックリスト

以下の項目を確認して、すべて完了したら入会手続き機能（3）が完了です！

- [ ] 承認処理のAPI Routeが作成されている
- [ ] 承認ボタンが動作し、申込みを承認できる
- [ ] 却下処理のAPI Routeが作成されている
- [ ] 却下ボタンが動作し、理由を入力して却下できる
- [ ] 承認・却下処理時に通知が作成される
- [ ] 通知テーブルに通知が正しく保存される
- [ ] 動作確認が完了している
- [ ] （余力があれば）練習枠データモデルを整理した
- [ ] （余力があれば）画面ラフ・UIイメージを作成した

---

## 📝 次のステップ

次回の作業内容：
- 時間予約機能の実装
- 練習枠の作成・管理機能
- 予約機能の実装

詳細は `開発スケジュール.md` を参照してください。

---

## ⚠️ トラブルシューティング

### エラー1: 承認処理に失敗しました

**エラーメッセージ例**:
```
承認処理に失敗しました
```

**原因**: データベースの更新エラー、または申込みが見つからない。

**解決方法**:

1. **申込みIDを確認**
   - URLパラメータの申込みIDが正しいか確認
   - データベースに該当するレコードが存在するか確認

2. **ステータスを確認**
   - 申込みのステータスが`pending`であることを確認
   - 既に処理済みの申込みは承認できない

3. **エラーログを確認**
   - ターミナルに表示されるエラーメッセージを確認

---

### エラー2: 却下理由を入力してください

**エラーメッセージ例**:
```
却下理由を入力してください
```

**原因**: 却下理由が入力されていない。

**解決方法**:

1. **却下理由を入力**
   - モーダルで却下理由を入力してください
   - 空白のみの入力は無効です

---

### エラー3: 通知の作成に失敗する

**エラーメッセージ例**:
```
通知作成エラー: ...
```

**原因**: 通知テーブルが存在しない、またはカラム名が間違っている。

**解決方法**:

1. **通知テーブルを確認**
   - Supabase Dashboardで`notifications`テーブルが存在するか確認
   - カラム名が正しいか確認（`message`または`content`）

2. **エラーログを確認**
   - ターミナルに表示されるエラーメッセージを確認
   - どのカラムが問題か確認

---

### エラー4: この申込みは既に処理済みです

**エラーメッセージ例**:
```
この申込みは既に処理済みです
```

**原因**: 申込みのステータスが既に`approved`または`rejected`になっている。

**解決方法**:

1. **ステータスを確認**
   - 申込み詳細ページでステータスを確認
   - 未確認（`pending`）の申込みのみ承認・却下できます

---

## 💡 よくある質問（FAQ）

### Q1: 承認・却下処理を取り消すことはできますか？

**A**: 現時点では取り消し機能は実装されていません。必要に応じて、管理者が手動でデータベースを更新するか、取り消し機能を追加で実装してください。

---

### Q2: 通知はどのようにユーザーに表示されますか？

**A**: 現時点では、通知はデータベースに保存されるだけです。次回以降の作業で、会員ページに通知一覧を表示する機能を実装予定です。

---

### Q3: 却下理由は必須ですか？

**A**: はい、却下する場合は理由の入力が必須です。理由がないと却下処理を実行できません。

---

### Q4: 複数の申込みを一度に承認・却下できますか？

**A**: 現時点では、1件ずつ処理する必要があります。一括処理機能は次回以降の作業で実装予定です。

---

### Q5: 通知の種類を追加したい場合は？

**A**: `notifications`テーブルの`type`カラムに新しい値を追加し、通知作成時にその値を指定してください。

---

## 📞 参考リンク

- **Supabase公式ドキュメント**: https://supabase.com/docs
- **Next.js App Router ドキュメント**: https://nextjs.org/docs/app
- **React公式ドキュメント**: https://ja.react.dev/

---

**最終更新**: 2026年2月14日  
**対象**: プログラミング初心者の方
