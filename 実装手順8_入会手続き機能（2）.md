# 入会手続き機能（2） 実装手順（初心者向け）

## 📚 このガイドについて

このガイドは、**2/13（金）: 入会手続き機能（2）**の作業を初心者の方でも理解できるように、**用語の説明**や**各ステップの詳細**を丁寧に記載しています。

**所要時間**: 約4〜5時間（初めての場合）

---

## 📖 用語集（最初に読んでおくと理解が深まります）

### データベース操作に関する用語

- **データベース**: 情報を保存する場所。このプロジェクトではSupabaseを使用します
- **テーブル**: データベースの中の、データを整理して保存する表のようなもの。例：`applications`テーブル（入会申込み情報を保存）
- **カラム（列）**: テーブルの中の1つ1つの項目。例：`name`（氏名）、`email`（メールアドレス）
- **レコード（行）**: テーブルの中の1件分のデータ。例：1件の入会申込み情報
- **INSERT**: データベースに新しいデータを追加する操作
- **SELECT**: データベースからデータを取得する操作
- **外部キー**: 他のテーブルを参照するためのキー。例：`applications`テーブルの`user_id`は`users`テーブルの`id`を参照

### API・サーバー側処理に関する用語

- **API Route**: Next.jsでサーバー側の処理を実行するためのエンドポイント（URL）
- **POSTリクエスト**: データを送信するためのHTTPリクエスト。フォーム送信などで使用
- **GETリクエスト**: データを取得するためのHTTPリクエスト。ページ表示などで使用
- **非同期処理（async/await）**: 時間がかかる処理（データベースへの保存など）を待つための仕組み

### 入会手続きに関する用語

- **申込み処理**: フォームに入力された内容をデータベースに保存する処理
- **申込み完了画面**: 申込みが正常に完了したことをユーザーに伝える画面
- **入会申込み一覧**: 管理者がすべての申込みを確認するためのページ
- **申込み詳細**: 1件の申込みの詳細情報を表示するページ

---

## 📋 今日（2/13）の作業内容

開発スケジュールの「2/13（金）: 入会手続き機能（2）」を完了するためのステップバイステップガイドです。

**目標**: 入会申込みフォームからデータベースに保存し、管理者が申込みを確認できる状態にする

**作成・更新するもの**:
1. 申込み処理の実装（データベースへの保存処理）
2. 申込み完了画面の作成
3. 管理者側の入会申込み一覧ページの作成
4. 管理者側の申込み詳細ページの作成

---

## ✅ ステップ1: データベーステーブルの確認

### 1-1. データベーステーブルとは？

**データベーステーブル**: 入会申込みの情報を保存するための表です。このプロジェクトでは、`applications`テーブルに申込み情報を保存します。

**現在の状態**: データベースのテーブルは既に作成されている想定です。このステップで、テーブルの構造を確認します。

---

### 1-2. Supabaseでのテーブル確認

**目的**: `applications`テーブルが正しく作成されているか確認します。

**手順**:

1. **Supabase Dashboardを開く**
   - https://supabase.com/dashboard にアクセス
   - プロジェクトを選択

2. **Table Editorを開く**
   - 左側のメニューから「Table Editor」をクリック
   - `applications`テーブルを選択

3. **テーブル構造を確認**
   - 以下のカラムが存在することを確認：
     - `id` (uuid, 主キー)
     - `user_id` (uuid, 外部キー → users.id)
     - `name` (text, 必須)
     - `name_kana` (text, 必須)
     - `grade` (text, 必須)
     - `phone` (text, 任意)
     - `email` (text, 任意)
     - `parent_name` (text, 任意)
     - `notes` (text, 任意)
     - `status` (text, デフォルト: 'pending')
     - `rejected_reason` (text, 任意)
     - `admin_memo` (text, 任意)
     - `created_at` (timestamptz)
     - `updated_at` (timestamptz)

**現在の状態**: ✅ データベーステーブルの構造を確認しました

---

## ✅ ステップ2: 申込み処理の実装（データベースへの保存）

### 2-1. 申込み処理とは？

**申込み処理**: フォームに入力された内容をデータベースに保存する処理です。ユーザーが「この内容で申込む」ボタンを押した時に実行されます。

**処理の流れ**:
1. ユーザーがフォームに入力
2. 「確認へ進む」ボタンをクリック
3. 確認画面で内容を確認
4. 「この内容で申込む」ボタンをクリック
5. **データベースに保存**（このステップで実装）
6. 申込み完了画面に遷移

---

### 2-2. API Routeの作成

**目的**: データベースに保存する処理をサーバー側で実行するためのAPI Routeを作成します。

**手順**:

1. **API Routeファイルを作成**
   - `frontend/app/api/applications/route.ts` を作成
   - フォルダが存在しない場合は作成してください

2. **以下のコードを追加**

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { supabase } from '@/lib/supabase'
import { auth } from '@/app/api/auth/[...nextauth]/route'

export async function POST(request: NextRequest) {
  try {
    // セッション情報を取得（ログインしているユーザーを確認）
    const session = await auth()
    
    if (!session?.user?.dbId) {
      return NextResponse.json(
        { error: 'ログインが必要です' },
        { status: 401 }
      )
    }

    // リクエストボディからフォームデータを取得
    const body = await request.json()
    const {
      childName,
      childFurigana,
      grade,
      parentName,
      email,
      phone,
      note,
    } = body

    // バリデーション（必須項目のチェック）
    if (!childName || !childFurigana || !grade || !email || !phone) {
      return NextResponse.json(
        { error: '必須項目が入力されていません' },
        { status: 400 }
      )
    }

    // データベースに保存
    const { data, error } = await supabase
      .from('applications')
      .insert({
        user_id: session.user.dbId,
        name: childName,
        name_kana: childFurigana,
        grade: grade,
        phone: phone,
        email: email,
        parent_name: parentName || null,
        notes: note || null,
        status: 'pending', // 初期状態は「未確認」
      })
      .select()
      .single()

    if (error) {
      console.error('データベース保存エラー:', error)
      return NextResponse.json(
        { error: '申込みの保存に失敗しました' },
        { status: 500 }
      )
    }

    // 成功レスポンス
    return NextResponse.json(
      { 
        success: true,
        applicationId: data.id 
      },
      { status: 201 }
    )
  } catch (error) {
    console.error('申込み処理エラー:', error)
    return NextResponse.json(
      { error: '申込み処理中にエラーが発生しました' },
      { status: 500 }
    )
  }
}
```

**コードの説明**:
- `POST`: POSTリクエストを受け取る関数
- `auth()`: セッション情報を取得（ログインしているユーザーを確認）
- `request.json()`: リクエストボディからJSONデータを取得
- `supabase.from('applications').insert()`: データベースに新しいレコードを追加
- `session.user.dbId`: ログインしているユーザーのデータベースID

**現在の状態**: ✅ API Routeが作成され、データベースに保存できるようになりました

---

### 2-3. 入会申込みフォームの更新

**目的**: 「この内容で申込む」ボタンをクリックした時に、API Routeを呼び出してデータベースに保存します。

**手順**:

1. **入会申込みページを開く**
   - `frontend/app/entry/page.tsx` を開く

2. **送信処理を追加**

既存の「この内容で申込む」ボタンの`onClick`を更新します：

```typescript
// 送信処理の状態を追加
const [isSubmitting, setIsSubmitting] = useState(false)
const [submitError, setSubmitError] = useState<string | null>(null)

// 送信処理の関数を追加
const handleSubmitApplication = async () => {
  setIsSubmitting(true)
  setSubmitError(null)

  try {
    // API Routeを呼び出してデータベースに保存
    const response = await fetch('/api/applications', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        childName: form.childName,
        childFurigana: form.childFurigana,
        grade: form.grade,
        parentName: form.parentName,
        email: form.email,
        phone: form.phone,
        note: form.note,
      }),
    })

    const data = await response.json()

    if (!response.ok) {
      throw new Error(data.error || '申込みの保存に失敗しました')
    }

    // 成功した場合、申込み完了画面に遷移
    window.location.href = `/entry/complete?id=${data.applicationId}`
  } catch (error) {
    console.error('申込みエラー:', error)
    setSubmitError(error instanceof Error ? error.message : '申込みの保存に失敗しました')
  } finally {
    setIsSubmitting(false)
  }
}
```

3. **「この内容で申込む」ボタンを更新**

確認画面の「この内容で申込む」ボタンを更新します：

```typescript
<Button
  type="button"
  className="w-full md:w-1/2"
  onClick={handleSubmitApplication}
  disabled={isSubmitting}
>
  {isSubmitting ? '送信中...' : 'この内容で申込む'}
</Button>

{submitError && (
  <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
    <p className="text-sm text-red-600">{submitError}</p>
  </div>
)}
```

**コードの説明**:
- `isSubmitting`: 送信中の状態を管理（ボタンを無効化するため）
- `submitError`: エラーメッセージを保存
- `fetch('/api/applications', ...)`: API Routeを呼び出してデータを送信
- `window.location.href`: 申込み完了画面に遷移

**現在の状態**: ✅ フォームからデータベースに保存できるようになりました

---

## ✅ ステップ3: 申込み完了画面の作成

### 3-1. 申込み完了画面とは？

**申込み完了画面**: 申込みが正常に完了したことをユーザーに伝える画面です。申込みIDを表示し、ユーザーが確認できるようにします。

---

### 3-2. 申込み完了ページの作成

**目的**: 申込み完了を表示するページを作成します。

**手順**:

1. **申込み完了ページファイルを作成**
   - `frontend/app/entry/complete/page.tsx` を作成

2. **以下のコードを追加**

```typescript
'use client'

import { useSearchParams } from 'next/navigation'
import { useEffect, useState } from 'react'
import Link from 'next/link'
import Button from '@/components/Button'

export default function EntryCompletePage() {
  const searchParams = useSearchParams()
  const applicationId = searchParams.get('id')
  const [application, setApplication] = useState<any>(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    // 申込みIDが取得できた場合、申込み情報を取得（オプション）
    if (applicationId) {
      // ここでは申込みIDを表示するだけでもOK
      setLoading(false)
    } else {
      setLoading(false)
    }
  }, [applicationId])

  if (loading) {
    return (
      <div className="container mx-auto px-4 py-16">
        <div className="max-w-2xl mx-auto text-center">
          <div className="text-gray-600">読み込み中...</div>
        </div>
      </div>
    )
  }

  return (
    <div className="container mx-auto px-4 py-16">
      <div className="max-w-2xl mx-auto bg-white rounded-lg shadow-md p-8 space-y-6">
        <div className="text-center">
          <div className="mx-auto w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-4">
            <svg
              className="w-8 h-8 text-green-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M5 13l4 4L19 7"
              />
            </svg>
          </div>
          <h1 className="text-2xl md:text-3xl font-bold text-gray-900 mb-4">
            入会申込みが完了しました
          </h1>
          <p className="text-gray-600 mb-6">
            お申込みありがとうございます。内容を確認のうえ、ご連絡させていただきます。
          </p>
        </div>

        <div className="bg-gray-50 rounded-lg p-6 space-y-4">
          <h2 className="text-lg font-semibold text-gray-900 mb-4">
            申込み内容
          </h2>
          {applicationId && (
            <div className="space-y-2">
              <div className="flex justify-between">
                <span className="text-gray-600">申込みID</span>
                <span className="font-mono text-sm text-gray-900">
                  {applicationId}
                </span>
              </div>
            </div>
          )}
          <p className="text-sm text-gray-600 mt-4">
            ※ 申込みIDは、お問い合わせの際にお伝えください。
          </p>
        </div>

        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <p className="text-sm text-blue-800">
            <strong>次のステップ</strong>
            <br />
            申込み内容を確認後、メールまたは電話にてご連絡させていただきます。
            承認が完了しましたら、入会手続きのご案内をお送りします。
          </p>
        </div>

        <div className="flex flex-col sm:flex-row gap-3 pt-4">
          <Link href="/" className="flex-1">
            <Button variant="secondary" className="w-full">
              ホームに戻る
            </Button>
          </Link>
          <Link href="/entry" className="flex-1">
            <Button className="w-full">
              もう一度申込む
            </Button>
          </Link>
        </div>
      </div>
    </div>
  )
}
```

**コードの説明**:
- `useSearchParams()`: URLパラメータ（`?id=...`）を取得
- `applicationId`: 申込みIDを表示
- チェックマークアイコン: 完了を視覚的に表現

**現在の状態**: ✅ 申込み完了画面が作成されました

---

## ✅ ステップ4: 管理者側の入会申込み一覧ページの作成

### 4-1. 入会申込み一覧とは？

**入会申込み一覧**: 管理者がすべての入会申込みを確認するためのページです。申込み一覧を表示し、各申込みのステータス（未確認・承認・却下）を確認できます。

---

### 4-2. 申込み一覧を取得するAPI Routeの作成

**目的**: データベースから申込み一覧を取得するAPI Routeを作成します。

**手順**:

1. **API Routeファイルを更新**
   - `frontend/app/api/applications/route.ts` を開く
   - 既存の`POST`関数に加えて、`GET`関数を追加

2. **以下のコードを追加**

```typescript
export async function GET(request: NextRequest) {
  try {
    // セッション情報を取得（管理者かどうかを確認）
    const session = await auth()
    
    if (!session?.user?.dbId) {
      return NextResponse.json(
        { error: 'ログインが必要です' },
        { status: 401 }
      )
    }

    // TODO: 管理者権限のチェック（後で実装）
    // 現時点では、ログインしていれば全員がアクセス可能

    // データベースから申込み一覧を取得
    const { data, error } = await supabase
      .from('applications')
      .select(`
        id,
        name,
        name_kana,
        grade,
        email,
        phone,
        status,
        created_at,
        users:user_id (
          name,
          email
        )
      `)
      .order('created_at', { ascending: false })

    if (error) {
      console.error('データベース取得エラー:', error)
      return NextResponse.json(
        { error: '申込み一覧の取得に失敗しました' },
        { status: 500 }
      )
    }

    return NextResponse.json({ applications: data || [] })
  } catch (error) {
    console.error('申込み一覧取得エラー:', error)
    return NextResponse.json(
      { error: '申込み一覧の取得中にエラーが発生しました' },
      { status: 500 }
    )
  }
}
```

**コードの説明**:
- `GET`: GETリクエストを受け取る関数
- `.select()`: 取得するカラムを指定
- `.order()`: 作成日時の降順で並び替え（新しい順）
- `users:user_id`: ユーザー情報を結合して取得

**現在の状態**: ✅ 申込み一覧を取得するAPI Routeが作成されました

---

### 4-3. 管理者側の入会申込み一覧ページの作成

**目的**: 管理者が申込み一覧を確認できるページを作成します。

**手順**:

1. **管理者ページファイルを作成**
   - `frontend/app/admin/applications/page.tsx` を作成
   - `admin`フォルダと`applications`フォルダが存在しない場合は作成してください

2. **以下のコードを追加**

```typescript
'use client'

import { useEffect, useState } from 'react'
import Link from 'next/link'
import Button from '@/components/Button'

type Application = {
  id: string
  name: string
  name_kana: string
  grade: string
  email: string | null
  phone: string | null
  status: string
  created_at: string
  users?: {
    name: string
    email: string | null
  }
}

export default function ApplicationsListPage() {
  const [applications, setApplications] = useState<Application[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    fetchApplications()
  }, [])

  const fetchApplications = async () => {
    try {
      setLoading(true)
      const response = await fetch('/api/applications')
      const data = await response.json()

      if (!response.ok) {
        throw new Error(data.error || '申込み一覧の取得に失敗しました')
      }

      setApplications(data.applications || [])
    } catch (error) {
      console.error('申込み一覧取得エラー:', error)
      setError(error instanceof Error ? error.message : '申込み一覧の取得に失敗しました')
    } finally {
      setLoading(false)
    }
  }

  const getStatusBadge = (status: string) => {
    const statusMap: Record<string, { label: string; className: string }> = {
      pending: { label: '未確認', className: 'bg-yellow-100 text-yellow-800' },
      approved: { label: '承認', className: 'bg-green-100 text-green-800' },
      rejected: { label: '却下', className: 'bg-red-100 text-red-800' },
    }

    const statusInfo = statusMap[status] || { label: status, className: 'bg-gray-100 text-gray-800' }

    return (
      <span className={`px-2 py-1 rounded-full text-xs font-semibold ${statusInfo.className}`}>
        {statusInfo.label}
      </span>
    )
  }

  const formatDate = (dateString: string) => {
    const date = new Date(dateString)
    return date.toLocaleDateString('ja-JP', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    })
  }

  if (loading) {
    return (
      <div className="container mx-auto px-4 py-16">
        <div className="max-w-6xl mx-auto text-center">
          <div className="text-gray-600">読み込み中...</div>
        </div>
      </div>
    )
  }

  if (error) {
    return (
      <div className="container mx-auto px-4 py-16">
        <div className="max-w-6xl mx-auto">
          <div className="bg-red-50 border border-red-200 rounded-lg p-4">
            <p className="text-red-600">{error}</p>
            <Button onClick={fetchApplications} className="mt-4">
              再読み込み
            </Button>
          </div>
        </div>
      </div>
    )
  }

  return (
    <div className="container mx-auto px-4 py-16">
      <div className="max-w-6xl mx-auto">
        <div className="mb-8">
          <h1 className="text-2xl md:text-3xl font-bold text-gray-900 mb-2">
            入会申込み一覧
          </h1>
          <p className="text-gray-600">
            すべての入会申込みを確認できます
          </p>
        </div>

        {applications.length === 0 ? (
          <div className="bg-white rounded-lg shadow-md p-8 text-center">
            <p className="text-gray-600">申込みがありません</p>
          </div>
        ) : (
          <div className="bg-white rounded-lg shadow-md overflow-hidden">
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      申込み日時
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      氏名
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      学年
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      連絡先
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      ステータス
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      操作
                    </th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {applications.map((application) => (
                    <tr key={application.id} className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {formatDate(application.created_at)}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="text-sm font-medium text-gray-900">
                          {application.name}
                        </div>
                        <div className="text-sm text-gray-500">
                          {application.name_kana}
                        </div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {application.grade}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div>{application.email || '-'}</div>
                        <div>{application.phone || '-'}</div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        {getStatusBadge(application.status)}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <Link
                          href={`/admin/applications/${application.id}`}
                          className="text-green-600 hover:text-green-900"
                        >
                          詳細を見る
                        </Link>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}
      </div>
    </div>
  )
}
```

**コードの説明**:
- `fetchApplications()`: API Routeを呼び出して申込み一覧を取得
- `getStatusBadge()`: ステータスに応じたバッジを表示
- `formatDate()`: 日時を日本語形式で表示
- テーブル形式で一覧を表示

**現在の状態**: ✅ 管理者側の入会申込み一覧ページが作成されました

---

## ✅ ステップ5: 管理者側の申込み詳細ページの作成

### 5-1. 申込み詳細ページとは？

**申込み詳細ページ**: 1件の申込みの詳細情報を表示するページです。すべての入力内容を確認でき、承認・却下の処理も行えます（承認・却下処理は次回実装）。

---

### 5-2. 申込み詳細を取得するAPI Routeの作成

**目的**: データベースから1件の申込み詳細を取得するAPI Routeを作成します。

**手順**:

1. **API Routeファイルを作成**
   - `frontend/app/api/applications/[id]/route.ts` を作成
   - `[id]`は動的ルート（申込みID）

2. **以下のコードを追加**

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { supabase } from '@/lib/supabase'
import { auth } from '@/app/api/auth/[...nextauth]/route'

export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    // セッション情報を取得
    const session = await auth()
    
    if (!session?.user?.dbId) {
      return NextResponse.json(
        { error: 'ログインが必要です' },
        { status: 401 }
      )
    }

    const applicationId = params.id

    // データベースから申込み詳細を取得
    const { data, error } = await supabase
      .from('applications')
      .select(`
        *,
        users:user_id (
          id,
          name,
          email,
          phone
        )
      `)
      .eq('id', applicationId)
      .single()

    if (error) {
      console.error('データベース取得エラー:', error)
      return NextResponse.json(
        { error: '申込み詳細の取得に失敗しました' },
        { status: 500 }
      )
    }

    if (!data) {
      return NextResponse.json(
        { error: '申込みが見つかりません' },
        { status: 404 }
      )
    }

    return NextResponse.json({ application: data })
  } catch (error) {
    console.error('申込み詳細取得エラー:', error)
    return NextResponse.json(
      { error: '申込み詳細の取得中にエラーが発生しました' },
      { status: 500 }
    )
  }
}
```

**コードの説明**:
- `[id]`: 動的ルートパラメータ（URLの`/api/applications/123`の`123`部分）
- `.eq('id', applicationId)`: IDで検索
- `.single()`: 1件のみ取得

**現在の状態**: ✅ 申込み詳細を取得するAPI Routeが作成されました

---

### 5-3. 管理者側の申込み詳細ページの作成

**目的**: 管理者が申込み詳細を確認できるページを作成します。

**手順**:

1. **申込み詳細ページファイルを作成**
   - `frontend/app/admin/applications/[id]/page.tsx` を作成

2. **以下のコードを追加**

```typescript
'use client'

import { useEffect, useState } from 'react'
import { useParams, useRouter } from 'next/navigation'
import Link from 'next/link'
import Button from '@/components/Button'

type Application = {
  id: string
  name: string
  name_kana: string
  grade: string
  email: string | null
  phone: string | null
  parent_name: string | null
  notes: string | null
  status: string
  rejected_reason: string | null
  admin_memo: string | null
  created_at: string
  updated_at: string
  users?: {
    id: string
    name: string
    email: string | null
    phone: string | null
  }
}

export default function ApplicationDetailPage() {
  const params = useParams()
  const router = useRouter()
  const applicationId = params.id as string
  const [application, setApplication] = useState<Application | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    if (applicationId) {
      fetchApplication()
    }
  }, [applicationId])

  const fetchApplication = async () => {
    try {
      setLoading(true)
      const response = await fetch(`/api/applications/${applicationId}`)
      const data = await response.json()

      if (!response.ok) {
        throw new Error(data.error || '申込み詳細の取得に失敗しました')
      }

      setApplication(data.application)
    } catch (error) {
      console.error('申込み詳細取得エラー:', error)
      setError(error instanceof Error ? error.message : '申込み詳細の取得に失敗しました')
    } finally {
      setLoading(false)
    }
  }

  const getStatusBadge = (status: string) => {
    const statusMap: Record<string, { label: string; className: string }> = {
      pending: { label: '未確認', className: 'bg-yellow-100 text-yellow-800' },
      approved: { label: '承認', className: 'bg-green-100 text-green-800' },
      rejected: { label: '却下', className: 'bg-red-100 text-red-800' },
    }

    const statusInfo = statusMap[status] || { label: status, className: 'bg-gray-100 text-gray-800' }

    return (
      <span className={`px-3 py-1 rounded-full text-sm font-semibold ${statusInfo.className}`}>
        {statusInfo.label}
      </span>
    )
  }

  const formatDate = (dateString: string) => {
    const date = new Date(dateString)
    return date.toLocaleDateString('ja-JP', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    })
  }

  if (loading) {
    return (
      <div className="container mx-auto px-4 py-16">
        <div className="max-w-4xl mx-auto text-center">
          <div className="text-gray-600">読み込み中...</div>
        </div>
      </div>
    )
  }

  if (error || !application) {
    return (
      <div className="container mx-auto px-4 py-16">
        <div className="max-w-4xl mx-auto">
          <div className="bg-red-50 border border-red-200 rounded-lg p-4">
            <p className="text-red-600">{error || '申込みが見つかりません'}</p>
            <div className="mt-4 flex gap-3">
              <Button onClick={fetchApplication}>再読み込み</Button>
              <Link href="/admin/applications">
                <Button variant="secondary">一覧に戻る</Button>
              </Link>
            </div>
          </div>
        </div>
      </div>
    )
  }

  return (
    <div className="container mx-auto px-4 py-16">
      <div className="max-w-4xl mx-auto">
        <div className="mb-6">
          <Link
            href="/admin/applications"
            className="text-green-600 hover:text-green-800 text-sm mb-4 inline-block"
          >
            ← 一覧に戻る
          </Link>
          <div className="flex items-center justify-between mt-2">
            <h1 className="text-2xl md:text-3xl font-bold text-gray-900">
              入会申込み詳細
            </h1>
            {getStatusBadge(application.status)}
          </div>
        </div>

        <div className="bg-white rounded-lg shadow-md p-8 space-y-6">
          <div className="space-y-4">
            <h2 className="text-xl font-semibold text-gray-900 border-b pb-2">
              申込み情報
            </h2>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-600 mb-1">
                  申込みID
                </label>
                <p className="text-gray-900 font-mono text-sm">{application.id}</p>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-600 mb-1">
                  申込み日時
                </label>
                <p className="text-gray-900">{formatDate(application.created_at)}</p>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-600 mb-1">
                  お子さまの氏名
                </label>
                <p className="text-gray-900">{application.name}</p>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-600 mb-1">
                  フリガナ
                </label>
                <p className="text-gray-900">{application.name_kana}</p>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-600 mb-1">
                  学年
                </label>
                <p className="text-gray-900">{application.grade}</p>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-600 mb-1">
                  メールアドレス
                </label>
                <p className="text-gray-900">{application.email || '（未入力）'}</p>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-600 mb-1">
                  電話番号
                </label>
                <p className="text-gray-900">{application.phone || '（未入力）'}</p>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-600 mb-1">
                  保護者氏名
                </label>
                <p className="text-gray-900">{application.parent_name || '（未入力）'}</p>
              </div>

              <div className="md:col-span-2">
                <label className="block text-sm font-medium text-gray-600 mb-1">
                  その他・ご質問など
                </label>
                <p className="text-gray-900 whitespace-pre-wrap">
                  {application.notes || '（未入力）'}
                </p>
              </div>
            </div>
          </div>

          {application.users && (
            <div className="space-y-4 pt-6 border-t">
              <h2 className="text-xl font-semibold text-gray-900 border-b pb-2">
                ユーザー情報
              </h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-600 mb-1">
                    ユーザー名
                  </label>
                  <p className="text-gray-900">{application.users.name}</p>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-600 mb-1">
                    ユーザーメールアドレス
                  </label>
                  <p className="text-gray-900">{application.users.email || '（未入力）'}</p>
                </div>
              </div>
            </div>
          )}

          {application.rejected_reason && (
            <div className="space-y-4 pt-6 border-t">
              <h2 className="text-xl font-semibold text-gray-900 border-b pb-2">
                却下理由
              </h2>
              <p className="text-gray-900 whitespace-pre-wrap">
                {application.rejected_reason}
              </p>
            </div>
          )}

          {application.admin_memo && (
            <div className="space-y-4 pt-6 border-t">
              <h2 className="text-xl font-semibold text-gray-900 border-b pb-2">
                管理者メモ
              </h2>
              <p className="text-gray-900 whitespace-pre-wrap">
                {application.admin_memo}
              </p>
            </div>
          )}

          <div className="pt-6 border-t">
            <div className="flex flex-col sm:flex-row gap-3">
              <Button
                variant="secondary"
                onClick={() => {
                  // 承認処理は次回実装
                  alert('承認処理は次回（2/14）に実装予定です')
                }}
                disabled={application.status !== 'pending'}
              >
                承認する
              </Button>
              <Button
                variant="secondary"
                onClick={() => {
                  // 却下処理は次回実装
                  alert('却下処理は次回（2/14）に実装予定です')
                }}
                disabled={application.status !== 'pending'}
              >
                却下する
              </Button>
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}
```

**コードの説明**:
- `useParams()`: URLパラメータ（申込みID）を取得
- `fetchApplication()`: API Routeを呼び出して申込み詳細を取得
- グリッドレイアウト: 情報を見やすく表示
- 承認・却下ボタン: 次回実装のため、現時点ではアラート表示

**現在の状態**: ✅ 管理者側の申込み詳細ページが作成されました

---

## ✅ ステップ6: 動作確認

### 6-1. 開発サーバーの起動

**手順**:

1. **開発サーバーを起動**
   ```bash
   cd frontend
   npm run dev
   ```

2. **起動を確認**
   - `- Local: http://localhost:3000` と表示されれば成功

---

### 6-2. 申込み処理の確認

**手順**:

1. **入会申込みフォームにアクセス**
   - ブラウザで `http://localhost:3000/entry` にアクセス
   - ログインが必要な場合は、先にログインしてください

2. **フォームに入力**
   - 必須項目をすべて入力
   - 「確認へ進む」ボタンをクリック

3. **確認画面で確認**
   - 入力内容が正しく表示されることを確認
   - 「この内容で申込む」ボタンをクリック

4. **申込み完了画面の確認**
   - 申込み完了画面に遷移することを確認
   - 申込みIDが表示されることを確認

5. **データベースの確認**
   - Supabase Dashboardで`applications`テーブルを確認
   - 新しいレコードが追加されていることを確認

---

### 6-3. 管理者側の一覧ページの確認

**手順**:

1. **入会申込み一覧ページにアクセス**
   - ブラウザで `http://localhost:3000/admin/applications` にアクセス
   - ログインが必要な場合は、先にログインしてください

2. **一覧の表示を確認**
   - 申込み一覧が表示されることを確認
   - ステータスバッジが正しく表示されることを確認

3. **詳細ページへの遷移を確認**
   - 「詳細を見る」リンクをクリック
   - 詳細ページに遷移することを確認

---

### 6-4. 管理者側の詳細ページの確認

**手順**:

1. **申込み詳細ページの表示を確認**
   - すべての入力内容が表示されることを確認
   - ユーザー情報が表示されることを確認

2. **一覧への戻りを確認**
   - 「一覧に戻る」リンクをクリック
   - 一覧ページに戻ることを確認

---

## ✅ 完了チェックリスト

以下の項目を確認して、すべて完了したら入会手続き機能（2）が完了です！

- [ ] データベーステーブルの構造を確認した
- [ ] 申込み処理のAPI Routeが作成されている
- [ ] 入会申込みフォームからデータベースに保存できる
- [ ] 申込み完了画面が表示される
- [ ] 申込み一覧を取得するAPI Routeが作成されている
- [ ] 管理者側の入会申込み一覧ページが表示される
- [ ] 申込み詳細を取得するAPI Routeが作成されている
- [ ] 管理者側の申込み詳細ページが表示される
- [ ] 動作確認が完了している

---

## 📝 次のステップ

次回（2/14）の作業内容：
- 入会承認・却下処理の実装
- 承認ボタン・却下ボタンの動作
- 却下理由の入力機能
- 通知送信機能（基本）

詳細は `開発スケジュール.md` を参照してください。

---

## ⚠️ トラブルシューティング

### エラー1: ログインが必要です

**エラーメッセージ例**:
```
{ error: 'ログインが必要です' }
```

**原因**: ログインしていない状態でAPI Routeにアクセスしている。

**解決方法**:

1. **ログインを確認**
   - 先にログインページ（`/login`）でログインしてください

2. **セッション情報を確認**
   - ブラウザの開発者ツールでセッション情報を確認
   - `session.user.dbId`が存在するか確認

---

### エラー2: データベース保存エラー

**エラーメッセージ例**:
```
データベース保存エラー: ...
```

**原因**: データベースのテーブル構造が正しくない、または外部キー制約に違反している。

**解決方法**:

1. **テーブル構造を確認**
   - Supabase Dashboardで`applications`テーブルの構造を確認
   - カラム名が正しいか確認

2. **外部キー制約を確認**
   - `user_id`が`users`テーブルの`id`を正しく参照しているか確認
   - `users`テーブルに該当するユーザーが存在するか確認

3. **エラーログを確認**
   - ターミナルに表示されるエラーメッセージを確認
   - どのカラムが問題か確認

---

### エラー3: 申込み一覧が取得できない

**エラーメッセージ例**:
```
申込み一覧の取得に失敗しました
```

**原因**: API Routeのエラー、またはデータベース接続の問題。

**解決方法**:

1. **API Routeを確認**
   - `frontend/app/api/applications/route.ts`の`GET`関数が正しく実装されているか確認

2. **Supabase接続を確認**
   - 環境変数（`NEXT_PUBLIC_SUPABASE_URL`、`NEXT_PUBLIC_SUPABASE_ANON_KEY`）が正しく設定されているか確認

3. **ブラウザのコンソールを確認**
   - 開発者ツールのコンソールにエラーが表示されていないか確認

---

### エラー4: 申込み詳細が取得できない

**エラーメッセージ例**:
```
申込みが見つかりません
```

**原因**: 申込みIDが間違っている、またはデータベースに該当するレコードが存在しない。

**解決方法**:

1. **申込みIDを確認**
   - URLパラメータの申込みIDが正しいか確認
   - データベースに該当するレコードが存在するか確認

2. **API Routeを確認**
   - `frontend/app/api/applications/[id]/route.ts`が正しく実装されているか確認
   - 動的ルートパラメータ（`params.id`）が正しく取得できているか確認

---

### エラー5: useSearchParams must be used within a Suspense boundary

**エラーメッセージ例**:
```
useSearchParams must be used within a Suspense boundary
```

**原因**: Next.js App Routerで`useSearchParams`を使用する場合、`Suspense`でラップする必要がある。

**解決方法**:

1. **Suspenseでラップ**
   - 申込み完了ページを`Suspense`でラップするか、親コンポーネントで`Suspense`を使用

2. **代替方法**
   - `useSearchParams`の代わりに、サーバーコンポーネントで`searchParams`を使用

---

## 💡 よくある質問（FAQ）

### Q1: ログインしていないユーザーが申込みできるようにしたい場合は？

**A**: API Routeの認証チェックを削除するか、オプショナルにしてください。ただし、セキュリティ上の理由から、ログイン必須にすることを推奨します。

---

### Q2: 管理者権限のチェックはどう実装しますか？

**A**: 次回（2/14）の作業で実装予定です。現時点では、ログインしていれば全員が管理者ページにアクセス可能です。

---

### Q3: 申込み一覧をページネーション（ページ分割）したい場合は？

**A**: API Routeで`limit`と`offset`パラメータを受け取り、データベースクエリに適用してください。フロントエンドでページネーションUIを実装します。

---

### Q4: 申込みを削除したい場合は？

**A**: API Routeに`DELETE`関数を追加し、データベースからレコードを削除する処理を実装してください。

---

### Q5: 申込みの検索機能を追加したい場合は？

**A**: API Routeで検索パラメータ（氏名、メールアドレスなど）を受け取り、データベースクエリに`ilike`や`eq`などの条件を追加してください。

---

## 📞 参考リンク

- **Supabase公式ドキュメント**: https://supabase.com/docs
- **Next.js App Router ドキュメント**: https://nextjs.org/docs/app
- **Next.js API Routes ドキュメント**: https://nextjs.org/docs/app/building-your-application/routing/route-handlers

---

**最終更新**: 2026年2月13日  
**対象**: プログラミング初心者の方
