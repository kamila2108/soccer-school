# デプロイ手順：追加更新と管理者ページ

このドキュメントでは、既にデプロイ済みのプロジェクト（`http://localhost:3000`）に変更を追加し、管理者ページ（`/admin`）を新規にデプロイする手順を説明します。

---

## 📋 前提条件

- 既にVercelにデプロイ済みのプロジェクトがある
- GitHubリポジトリが設定されている
- Vercelアカウントにログインできる

---

## 🎯 ステップ1: 変更内容の確認

### 1-1. 追加された機能の確認

今回追加された主な機能：

1. **練習予約機能**
   - 練習一覧ページ（`/member/practice-slots`）
   - 予約一覧ページ（`/member/reservations`）
   - 予約・キャンセル機能

2. **管理者ダッシュボード**
   - 管理者ダッシュボード（`/admin`）
   - 入会管理と練習枠管理の統合表示
   - 練習枠管理機能（`/admin/practice-slots`）

3. **UIの改善**
   - ホームページに「練習予約」ボタンを追加
   - Headerに「練習予約」リンクを追加
   - 練習一覧と予約一覧の相互リンク

### 1-2. 追加が必要な環境変数

管理者ページ用の環境変数は、既存の環境変数と同じものを使用します。追加の環境変数は**不要**です。

---

## 🔄 ステップ2: コードをGitHubにプッシュ

### 2-1. 変更内容をコミット

プロジェクトのルートディレクトリ（`C:\Users\tokam\Downloads\soccer`）で、以下のコマンドを実行します：

```bash
# 変更されたファイルを確認
git status

# すべての変更をステージング
git add .

# コミット（変更内容を記録）
git commit -m "練習予約機能と管理者ダッシュボードを追加"

# GitHubにプッシュ
git push origin main
```

**注意**: 
- ブランチ名が `master` の場合は、`git push origin master` を使用してください
- 初回の場合は、GitHubの認証情報を入力する必要があります

### 2-2. プッシュの確認

1. GitHubのリポジトリページにアクセス
2. 最新のコミットが表示されていることを確認
3. 変更されたファイルが正しくアップロードされていることを確認

---

## 🚀 ステップ3: Vercelでの自動デプロイ

### 3-1. 自動デプロイの確認

Vercelは、GitHubの `main` ブランチ（または `master` ブランチ）にプッシュされると、自動的にデプロイを開始します。

1. Vercelのダッシュボード（https://vercel.com/dashboard）にアクセス
2. プロジェクトを選択
3. 「Deployments」タブを開く
4. 新しいデプロイが開始されていることを確認（「Building...」と表示されます）

### 3-2. デプロイの完了を待つ

- デプロイには通常、2〜5分程度かかります
- 「Ready」と表示されれば、デプロイ完了です

---

## ✅ ステップ4: 動作確認

### 4-1. 既存機能の確認

既存のURL（例: `https://your-project-name.vercel.app`）にアクセスして、以下を確認します：

1. **ホームページ**
   - 「練習予約」ボタンが表示される
   - クリックすると練習一覧ページに遷移する

2. **Header**
   - ログイン済みユーザーに「練習予約」リンクが表示される
   - 「管理者ダッシュボード」リンクは**表示されない**（生徒側では非表示）

3. **練習一覧ページ**（`/member/practice-slots`）
   - 練習枠が正しく表示される
   - 「予約一覧を見る」ボタンが表示される
   - 予約・キャンセル機能が動作する

4. **予約一覧ページ**（`/member/reservations`）
   - 予約一覧が正しく表示される
   - 「練習一覧に戻る」ボタンが表示される
   - キャンセル機能が動作する

### 4-2. 管理者ページの確認

**重要**: 管理者ページは、既存のURLに `/admin` を追加したURLでアクセスします。

1. **管理者ダッシュボード**
   - URL: `https://your-project-name.vercel.app/admin`
   - 入会管理と練習枠管理が表示される
   - 統計カードが正しく表示される

2. **練習枠管理**
   - URL: `https://your-project-name.vercel.app/admin/practice-slots`
   - 練習枠一覧が表示される
   - 新規登録・編集・削除機能が動作する

3. **入会管理**
   - URL: `https://your-project-name.vercel.app/admin/applications`
   - 入会申込み一覧が表示される
   - 詳細確認機能が動作する

### 4-3. エラーの確認

もしエラーが発生した場合：

1. **ブラウザの開発者ツール（F12キー）を開く**
   - 「Console」タブでエラーメッセージを確認

2. **Vercelのログを確認**
   - 「Deployments」タブ → 最新のデプロイ → 「Function Logs」
   - サーバー側のエラーを確認

3. **ビルドログを確認**
   - 「Deployments」タブ → 最新のデプロイ → 「Build Logs」
   - ビルドエラーがないか確認

---

## 🔧 ステップ5: 環境変数の確認（必要に応じて）

### 5-1. 既存の環境変数

管理者ページも、既存の環境変数を使用します。以下の環境変数が設定されていることを確認してください：

| 変数名 | 説明 |
|--------|------|
| `NEXT_PUBLIC_SUPABASE_URL` | SupabaseプロジェクトのURL |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | Supabaseの公開キー |
| `SUPABASE_SERVICE_ROLE_KEY` | Supabaseのサービスロールキー（管理者ページで使用） |
| `NEXTAUTH_SECRET` | NextAuthの秘密鍵 |
| `NEXTAUTH_URL` | アプリケーションのURL（例: `https://your-project-name.vercel.app`） |
| `LINE_CHANNEL_ID` | LINEログインのチャネルID（使用する場合） |
| `LINE_CHANNEL_SECRET` | LINEログインのチャネルシークレット（使用する場合） |

### 5-2. 環境変数の確認方法

1. Vercelのダッシュボードでプロジェクトを選択
2. 「Settings」タブをクリック
3. 「Environment Variables」を開く
4. 上記の環境変数がすべて設定されていることを確認

### 5-3. 追加が必要な環境変数

**管理者ページ用の追加環境変数は不要です。** 既存の環境変数で動作します。

ただし、`SUPABASE_SERVICE_ROLE_KEY` が設定されていない場合は、追加してください：

1. [Supabase Dashboard](https://supabase.com/dashboard) にアクセス
2. プロジェクトを選択
3. 「Settings」→「API」をクリック
4. 「service_role key」をコピー（⚠️ このキーは秘密情報です。公開しないでください）
5. Vercelの「Environment Variables」に追加：
   - Key: `SUPABASE_SERVICE_ROLE_KEY`
   - Value: コピーしたサービスロールキー
   - Environment: Production, Preview, Development すべてにチェック

### 5-4. NEXTAUTH_URLの環境ごとの設定（重要）

**⚠️ 重要**: `NEXTAUTH_URL`は環境ごとに異なる値を設定する必要があります。

**設定方法：**

1. Vercelの「Environment Variables」で`NEXTAUTH_URL`を探す
2. 「Edit」をクリック
3. 環境ごとに異なる値を設定：
   - **Production（本番環境）**: 本番URL（例: `https://your-project-name.vercel.app`）
   - **Preview（プレビュー環境）**: プレビューURLまたは本番URL
   - **Development（開発環境）**: `http://localhost:3000`（ローカル開発用）

**なぜ必要か：**
- NextAuthは`NEXTAUTH_URL`を使用して認証のコールバックURLを生成します
- 本番環境で`http://localhost:3000`のままでは、認証のリダイレクトが正しく動作しません
- Vercelでは環境ごとに異なる値を設定できるため、開発環境は`localhost:3000`のままで問題ありません

**設定後の確認：**
- 環境変数を変更した後は、**必ず再デプロイ**を実行してください
- 「Deployments」タブから最新のデプロイを「Redeploy」してください

---

## 🎨 ステップ6: 管理者ページのURL構造

### 6-1. URLの構造

管理者ページは、既存のURLに `/admin` を追加したURLでアクセスします：

| ページ | URL |
|--------|-----|
| 管理者ダッシュボード | `https://your-project-name.vercel.app/admin` |
| 練習枠一覧 | `https://your-project-name.vercel.app/admin/practice-slots` |
| 練習枠新規登録 | `https://your-project-name.vercel.app/admin/practice-slots/new` |
| 練習枠編集 | `https://your-project-name.vercel.app/admin/practice-slots/[id]/edit` |
| 入会申込み一覧 | `https://your-project-name.vercel.app/admin/applications` |
| 入会申込み詳細 | `https://your-project-name.vercel.app/admin/applications/[id]` |

### 6-2. アクセス方法

1. **直接URLでアクセス**
   - ブラウザのアドレスバーに `https://your-project-name.vercel.app/admin` と入力

2. **ログインが必要**
   - 管理者ページにアクセスするには、ログインが必要です
   - ログインしていない場合は、自動的にログインページにリダイレクトされます

---

## 🔄 ステップ7: 今後の更新方法

### 7-1. コードを更新した場合

1. ローカルでコードを変更
2. 変更をGitHubにプッシュ：
   ```bash
   git add .
   git commit -m "更新内容の説明"
   git push origin main
   ```
3. Vercelが自動的に変更を検出して、再デプロイを開始します
4. 数分後、新しいバージョンが公開されます

### 7-2. 環境変数を変更した場合

1. Vercelの「Settings」→「Environment Variables」で環境変数を変更
2. 変更後、**必ず再デプロイを実行**します：
   - 「Deployments」タブを開く
   - 最新のデプロイの右側にある「...」（三点メニュー）をクリック
   - 「Redeploy」を選択
   - 「Use existing Build Cache」のチェックを**外す**
   - 「Redeploy」をクリック

---

## 🐛 トラブルシューティング

### エラー: 管理者ページが404エラーになる

**原因**: ビルドエラーやルーティングの問題

**解決方法**:
1. Vercelの「Deployments」タブで、最新のデプロイの「Build Logs」を確認
2. エラーメッセージがないか確認
3. ローカルでビルドを確認：
   ```bash
   cd frontend
   npm run build
   ```
4. ビルドが成功することを確認

### エラー: 管理者ページにアクセスできない（認証エラー）

**原因**: ログインしていない、または認証情報が正しくない

**解決方法**:
1. まず、通常のログインページ（`/login`）でログイン
2. ログイン後、管理者ページ（`/admin`）にアクセス
3. まだエラーが表示される場合は、環境変数 `NEXTAUTH_URL` が正しく設定されているか確認

### エラー: 練習枠のデータが表示されない

**原因**: Supabaseの接続エラーまたは環境変数の問題

**解決方法**:
1. Vercelの環境変数 `NEXT_PUBLIC_SUPABASE_URL` と `NEXT_PUBLIC_SUPABASE_ANON_KEY` が正しく設定されているか確認
2. Supabase Dashboardで、データベースにデータが存在するか確認
3. ブラウザの開発者ツール（F12キー）→「Console」タブでエラーメッセージを確認

---

## 📝 デプロイ前チェックリスト

デプロイ前に以下を確認してください：

- [ ] コードがGitHubにプッシュされている
- [ ] Vercelで自動デプロイが開始されている（または手動でデプロイを実行）
- [ ] すべての環境変数が設定されている：
  - [ ] `NEXT_PUBLIC_SUPABASE_URL`
  - [ ] `NEXT_PUBLIC_SUPABASE_ANON_KEY`
  - [ ] `SUPABASE_SERVICE_ROLE_KEY`（管理者ページで使用）
  - [ ] `NEXTAUTH_SECRET`
  - [ ] `NEXTAUTH_URL`（デプロイ後のURLに設定）
- [ ] ローカルで `npm run build` が成功することを確認
- [ ] デプロイが完了したら、各ページにアクセスして動作確認

---

## 🎯 まとめ

### デプロイの流れ

1. **コードをGitHubにプッシュ** → Vercelが自動的にデプロイを開始
2. **デプロイ完了を待つ** → 通常2〜5分
3. **動作確認** → 既存のURLと `/admin` のURLで確認

### 管理者ページのURL

- **既存のURL**: `https://your-project-name.vercel.app`
- **管理者ダッシュボード**: `https://your-project-name.vercel.app/admin`
- **練習枠管理**: `https://your-project-name.vercel.app/admin/practice-slots`
- **入会管理**: `https://your-project-name.vercel.app/admin/applications`

### 重要なポイント

- ✅ 管理者ページは既存のURLに `/admin` を追加したURLでアクセス
- ✅ 追加の環境変数は不要（既存の環境変数で動作）
- ✅ コードをプッシュすると自動的にデプロイされる
- ✅ 生徒側のページでは管理者ダッシュボードのリンクは表示されない

---

**デプロイ完了後、本番環境でアプリケーションが正常に動作することを確認してください！** 🎉
