# 時間予約機能（2）＋（3） 実装手順（初心者向け）

## 📚 このガイドについて

このガイドは、**2/16（月）: 時間予約機能（2）＋（3）**の作業を初心者の方でも理解できるように、**用語の説明**や**各ステップの詳細**を丁寧に記載しています。

**所要時間**: 約5〜6時間（初めての場合）

---

## 📖 用語集（最初に読んでおくと理解が深まります）

### 予約機能に関する用語

- **予約**: 会員が練習枠に参加を申し込むこと
- **予約一覧**: 会員が予約した練習の一覧を表示するページ
- **練習一覧**: 予約可能な練習枠の一覧を表示するページ
- **空き状況**: 練習枠に空きがあるかどうかの状態
- **空き枠**: まだ予約できる人数（定員 - 現在の予約数）
- **キャンセル**: 予約を取り消すこと
- **予約制約**: 予約に関するルール（例: 1人あたりの予約上限数、予約締切日時など）

### 予約ステータスに関する用語

- **ACTIVE**: 予約中（有効な予約）
- **CANCELLED**: キャンセル済み（予約が取り消された状態）
- **COMPLETED**: 参加済み（練習が終了した状態）

### 練習枠ステータスに関する用語

- **OPEN**: 受付中（予約を受け付けている状態）
- **FULL**: 満席（定員に達している状態）
- **CLOSED**: 受付終了（管理者が手動で受付を終了した状態）
- **CANCELLED**: 中止（練習が中止になった状態）

---

## 📋 今日（2/16）の作業内容

開発スケジュールの「2/16（月）: 時間予約機能（2）＋（3）」を完了するためのステップバイステップガイドです。

**目標**: 会員が練習枠を確認し、予約・キャンセルができる機能を実装する

**作成・更新するもの**:
1. 練習一覧ページ（`/member/practice-slots`）
2. 予約一覧ページ（`/member/reservations`）
3. 予約・キャンセル用のAPIエンドポイント（`/api/reservations`）
4. 空き状況の計算ロジック
5. 予約制約の実装

---

## ✅ ステップ1: 予約APIエンドポイントの実装

### 1-1. 予約APIエンドポイントとは？

**予約APIエンドポイント**: フロントエンド（画面）とデータベースの間で予約データをやり取りする仕組みです。

**今回作成するAPIエンドポイント**:
- `GET /api/reservations`: 予約一覧を取得（自分の予約のみ）
- `POST /api/reservations`: 新しい予約を作成
- `DELETE /api/reservations/[id]`: 予約をキャンセル

---

### 1-2. 予約一覧取得APIの実装

**目的**: ログインしている会員の予約一覧を取得するAPIを作成します。

**手順**:

1. **APIルートファイルを作成**
   - `frontend/app/api/reservations/route.ts` を作成

2. **以下のコードを追加**

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { supabaseAdmin } from '@/lib/supabase-admin'
import { auth } from '@/app/api/auth/[...nextauth]/route'

// 予約一覧を取得（自分の予約のみ）
export async function GET(request: NextRequest) {
  try {
    // セッション情報を取得（ログインしているユーザーを確認）
    const session = await auth()
    
    if (!session?.user?.dbId) {
      return NextResponse.json(
        { error: 'ログインが必要です' },
        { status: 401 }
      )
    }

    // データベースから予約一覧を取得（自分の予約のみ）
    const { data, error } = await supabaseAdmin
      .from('reservations')
      .select(`
        id,
        status,
        created_at,
        cancelled_at,
        practice_slots:practice_slot_id (
          id,
          practice_date,
          start_time,
          end_time,
          capacity,
          current_reservations,
          status,
          notes
        )
      `)
      .eq('user_id', session.user.dbId)
      .eq('status', 'active') // 有効な予約のみ
      .order('created_at', { ascending: false })

    if (error) {
      console.error('データベース取得エラー:', error)
      return NextResponse.json(
        { error: '予約一覧の取得に失敗しました' },
        { status: 500 }
      )
    }

    // データ形式を変換（スネークケース → キャメルケース）
    const reservations = (data || []).map((reservation) => ({
      id: reservation.id,
      status: reservation.status,
      createdAt: reservation.created_at,
      cancelledAt: reservation.cancelled_at,
      practiceSlot: {
        id: reservation.practice_slots.id,
        date: reservation.practice_slots.practice_date || reservation.practice_slots.date,
        startTime: reservation.practice_slots.start_time,
        endTime: reservation.practice_slots.end_time,
        capacity: reservation.practice_slots.capacity,
        currentBookings: reservation.practice_slots.current_reservations || reservation.practice_slots.current_bookings || 0,
        status: (reservation.practice_slots.status || '').toUpperCase(),
        notes: reservation.practice_slots.notes,
      },
    }))

    return NextResponse.json({ reservations })
  } catch (error) {
    console.error('予約一覧取得エラー:', error)
    return NextResponse.json(
      { error: '予約一覧の取得中にエラーが発生しました' },
      { status: 500 }
    )
  }
}
```

**コードの説明**:
- `GET`: HTTPメソッドで、データを取得する際に使用
- `.eq('user_id', session.user.dbId)`: ログインしているユーザーの予約のみを取得
- `.eq('status', 'active')`: 有効な予約（キャンセルされていない予約）のみを取得
- `.select()`: 関連する練習枠情報も一緒に取得（JOINのような動作）

**現在の状態**: ✅ 予約一覧取得APIが実装されました

---

### 1-3. 予約作成APIの実装

**目的**: 新しい予約をデータベースに保存するAPIを作成します。

**手順**:

1. **同じファイルにPOST関数を追加**
   - `frontend/app/api/reservations/route.ts` に以下を追加

```typescript
// 新しい予約を作成
export async function POST(request: NextRequest) {
  try {
    // セッション情報を取得（ログインしているユーザーを確認）
    const session = await auth()
    
    if (!session?.user?.dbId) {
      return NextResponse.json(
        { error: 'ログインが必要です' },
        { status: 401 }
      )
    }

    // リクエストボディからフォームデータを取得
    const body = await request.json()
    const { practiceSlotId } = body

    // バリデーション（必須項目のチェック）
    if (!practiceSlotId) {
      return NextResponse.json(
        { error: '練習枠IDが指定されていません' },
        { status: 400 }
      )
    }

    // 練習枠の情報を取得
    const { data: slotData, error: slotError } = await supabaseAdmin
      .from('practice_slots')
      .select('*')
      .eq('id', practiceSlotId)
      .single()

    if (slotError || !slotData) {
      return NextResponse.json(
        { error: '練習枠が見つかりません' },
        { status: 404 }
      )
    }

    // 予約制約のチェック
    // 1. 練習枠のステータスが予約可能かチェック
    const slotStatus = (slotData.status || '').toLowerCase()
    if (slotStatus !== 'open') {
      return NextResponse.json(
        { error: 'この練習枠は予約できません' },
        { status: 400 }
      )
    }

    // 2. 空きがあるかチェック
    const currentBookings = slotData.current_reservations || slotData.current_bookings || 0
    if (currentBookings >= slotData.capacity) {
      return NextResponse.json(
        { error: 'この練習枠は満席です' },
        { status: 400 }
      )
    }

    // 3. 既に予約していないかチェック（重複予約の防止）
    const { data: existingReservation } = await supabaseAdmin
      .from('reservations')
      .select('id')
      .eq('user_id', session.user.dbId)
      .eq('practice_slot_id', practiceSlotId)
      .eq('status', 'active')
      .single()

    if (existingReservation) {
      return NextResponse.json(
        { error: 'この練習枠は既に予約済みです' },
        { status: 400 }
      )
    }

    // 4. 予約上限数のチェック（例: 1人あたり最大3件まで）
    const MAX_RESERVATIONS = 3
    const { data: userReservations } = await supabaseAdmin
      .from('reservations')
      .select('id')
      .eq('user_id', session.user.dbId)
      .eq('status', 'active')

    if (userReservations && userReservations.length >= MAX_RESERVATIONS) {
      return NextResponse.json(
        { error: `予約上限数（${MAX_RESERVATIONS}件）に達しています` },
        { status: 400 }
      )
    }

    // トランザクション処理: 予約を作成し、練習枠の予約数を更新
    // 注意: Supabaseではトランザクションが直接サポートされていないため、
    // 順番に実行し、エラーが発生した場合はロールバック処理を実装する

    // 1. 予約を作成
    const { data: reservationData, error: reservationError } = await supabaseAdmin
      .from('reservations')
      .insert({
        user_id: session.user.dbId,
        practice_slot_id: practiceSlotId,
        status: 'active',
      })
      .select()
      .single()

    if (reservationError) {
      console.error('予約作成エラー:', reservationError)
      return NextResponse.json(
        { 
          error: '予約の作成に失敗しました',
          details: reservationError.message || 'データベースエラーが発生しました'
        },
        { status: 500 }
      )
    }

    // 2. 練習枠の予約数を更新
    const newCurrentBookings = currentBookings + 1
    let newStatus = slotStatus
    
    // 満席になった場合はステータスを更新
    if (newCurrentBookings >= slotData.capacity) {
      newStatus = 'full'
    }

    const { error: updateError } = await supabaseAdmin
      .from('practice_slots')
      .update({
        current_reservations: newCurrentBookings,
        status: newStatus,
      })
      .eq('id', practiceSlotId)

    if (updateError) {
      console.error('練習枠更新エラー:', updateError)
      // 予約は作成されたが、練習枠の更新に失敗した場合
      // 実際の運用では、この場合のロールバック処理を実装することを推奨
      return NextResponse.json(
        { 
          error: '予約は作成されましたが、練習枠の更新に失敗しました',
          details: updateError.message || 'データベースエラーが発生しました'
        },
        { status: 500 }
      )
    }

    // 成功レスポンス
    return NextResponse.json(
      { 
        success: true,
        reservation: {
          id: reservationData.id,
          practiceSlotId: practiceSlotId,
        }
      },
      { status: 201 }
    )
  } catch (error) {
    console.error('予約作成エラー:', error)
    return NextResponse.json(
      { error: '予約作成中にエラーが発生しました' },
      { status: 500 }
    )
  }
}
```

**コードの説明**:
- `POST`: HTTPメソッドで、新しいデータを作成する際に使用
- 予約制約のチェック: 練習枠のステータス、空き状況、重複予約、予約上限数をチェック
- トランザクション処理: 予約作成と練習枠更新を順番に実行
- 満席判定: 予約数が定員に達した場合、ステータスを`full`に更新

**現在の状態**: ✅ 予約作成APIが実装されました

---

### 1-4. 予約キャンセルAPIの実装

**目的**: 予約をキャンセルするAPIを作成します。

**手順**:

1. **APIルートファイルを作成**
   - `frontend/app/api/reservations/[id]/route.ts` を作成

2. **以下のコードを追加**

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { supabaseAdmin } from '@/lib/supabase-admin'
import { auth } from '@/app/api/auth/[...nextauth]/route'

// 予約をキャンセル
export async function DELETE(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> | { id: string } }
) {
  try {
    // セッション情報を取得
    const session = await auth()
    
    if (!session?.user?.dbId) {
      return NextResponse.json(
        { error: 'ログインが必要です' },
        { status: 401 }
      )
    }

    // Next.js 15ではparamsがPromiseになる可能性があるため、awaitする
    const resolvedParams = await Promise.resolve(params)
    const { id } = resolvedParams

    // 予約情報を取得（自分の予約か確認）
    const { data: reservationData, error: reservationError } = await supabaseAdmin
      .from('reservations')
      .select('*, practice_slots:practice_slot_id (*)')
      .eq('id', id)
      .eq('user_id', session.user.dbId)
      .eq('status', 'active')
      .single()

    if (reservationError || !reservationData) {
      return NextResponse.json(
        { error: '予約が見つかりません' },
        { status: 404 }
      )
    }

    const practiceSlot = reservationData.practice_slots
    const currentBookings = practiceSlot.current_reservations || practiceSlot.current_bookings || 0

    // 1. 予約をキャンセル（ステータスを'cancelled'に更新）
    const { error: cancelError } = await supabaseAdmin
      .from('reservations')
      .update({
        status: 'cancelled',
        cancelled_at: new Date().toISOString(),
      })
      .eq('id', id)

    if (cancelError) {
      console.error('予約キャンセルエラー:', cancelError)
      return NextResponse.json(
        { error: '予約のキャンセルに失敗しました' },
        { status: 500 }
      )
    }

    // 2. 練習枠の予約数を更新
    const newCurrentBookings = Math.max(0, currentBookings - 1)
    let newStatus = (practiceSlot.status || '').toLowerCase()
    
    // 満席から空きが出た場合はステータスを'open'に更新
    if (newStatus === 'full' && newCurrentBookings < practiceSlot.capacity) {
      newStatus = 'open'
    }

    const { error: updateError } = await supabaseAdmin
      .from('practice_slots')
      .update({
        current_reservations: newCurrentBookings,
        status: newStatus,
      })
      .eq('id', practiceSlot.id)

    if (updateError) {
      console.error('練習枠更新エラー:', updateError)
      // 予約はキャンセルされたが、練習枠の更新に失敗した場合
      return NextResponse.json(
        { 
          error: '予約はキャンセルされましたが、練習枠の更新に失敗しました',
          details: updateError.message || 'データベースエラーが発生しました'
        },
        { status: 500 }
      )
    }

    return NextResponse.json({ 
      success: true,
      message: '予約をキャンセルしました'
    })
  } catch (error) {
    console.error('予約キャンセルエラー:', error)
    return NextResponse.json(
      { error: '予約キャンセル中にエラーが発生しました' },
      { status: 500 }
    )
  }
}
```

**コードの説明**:
- `DELETE`: HTTPメソッドで、データを削除する際に使用
- `.eq('user_id', session.user.dbId)`: 自分の予約のみキャンセルできるようにする
- キャンセル処理: 予約のステータスを`cancelled`に更新し、`cancelled_at`を記録
- 練習枠の更新: 予約数を減らし、満席から空きが出た場合はステータスを`open`に更新

**現在の状態**: ✅ 予約キャンセルAPIが実装されました

---

## ✅ ステップ2: 練習一覧ページの実装

### 2-1. 練習一覧ページとは？

**練習一覧ページ**: 予約可能な練習枠の一覧を表示するページです。会員が練習を確認し、予約できるようにします。

**表示する情報**:
- 練習日
- 開始時間・終了時間
- 定員・現在の予約数・空き枠
- ステータス
- 予約ボタン

---

### 2-2. 練習一覧ページの作成

**目的**: 予約可能な練習枠の一覧を表示し、予約ボタンを配置します。

**手順**:

1. **練習一覧ページを作成**
   - `frontend/app/member/practice-slots/page.tsx` を作成

2. **以下のコードを追加**

```typescript
'use client'

import { useEffect, useState } from 'react'
import { useSession } from 'next-auth/react'
import { useRouter } from 'next/navigation'
import Button from '@/components/Button'
import { PracticeSlot, SlotStatusLabels, SlotStatusBadgeClasses, isSlotAvailable, getRemainingCapacity, formatSlotDate } from '@/types/practice-slot'

export default function PracticeSlotsListPage() {
  const { data: session } = useSession()
  const router = useRouter()
  const [practiceSlots, setPracticeSlots] = useState<PracticeSlot[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [reservingSlotId, setReservingSlotId] = useState<string | null>(null)

  useEffect(() => {
    fetchPracticeSlots()
  }, [])

  const fetchPracticeSlots = async () => {
    try {
      setLoading(true)
      // 予約可能な練習枠のみを取得（OPENステータスのみ）
      const response = await fetch('/api/practice-slots?status=OPEN')
      const data = await response.json()

      if (!response.ok) {
        throw new Error(data.error || '練習枠一覧の取得に失敗しました')
      }

      // 未来の日付の練習枠のみを表示
      const today = new Date()
      today.setHours(0, 0, 0, 0)
      
      const futureSlots = (data.practiceSlots || []).filter((slot: PracticeSlot) => {
        const slotDate = new Date(slot.date)
        slotDate.setHours(0, 0, 0, 0)
        return slotDate >= today
      })

      setPracticeSlots(futureSlots)
    } catch (error) {
      console.error('練習枠一覧取得エラー:', error)
      setError(error instanceof Error ? error.message : '練習枠一覧の取得に失敗しました')
    } finally {
      setLoading(false)
    }
  }

  const handleReserve = async (slotId: string) => {
    if (!session?.user?.dbId) {
      router.push('/login')
      return
    }

    if (!confirm('この練習枠を予約しますか？')) {
      return
    }

    try {
      setReservingSlotId(slotId)

      const response = await fetch('/api/reservations', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          practiceSlotId: slotId,
        }),
      })

      const data = await response.json()

      if (!response.ok) {
        throw new Error(data.error || '予約に失敗しました')
      }

      alert('予約が完了しました')
      // 一覧を再取得
      fetchPracticeSlots()
    } catch (error) {
      console.error('予約エラー:', error)
      alert(error instanceof Error ? error.message : '予約に失敗しました')
    } finally {
      setReservingSlotId(null)
    }
  }

  if (loading) {
    return (
      <div className="container mx-auto px-4 py-16">
        <div className="max-w-6xl mx-auto text-center">
          <div className="text-gray-600">読み込み中...</div>
        </div>
      </div>
    )
  }

  if (error) {
    return (
      <div className="container mx-auto px-4 py-16">
        <div className="max-w-6xl mx-auto">
          <div className="bg-red-50 border border-red-200 rounded-lg p-4">
            <p className="text-red-600">{error}</p>
            <Button onClick={fetchPracticeSlots} className="mt-4">
              再読み込み
            </Button>
          </div>
        </div>
      </div>
    )
  }

  return (
    <div className="container mx-auto px-4 py-16">
      <div className="max-w-6xl mx-auto">
        <div className="mb-8">
          <h1 className="text-2xl md:text-3xl font-bold text-gray-900 mb-2">
            練習一覧
          </h1>
          <p className="text-gray-600">
            予約可能な練習枠を確認できます
          </p>
        </div>

        {practiceSlots.length === 0 ? (
          <div className="bg-white rounded-lg shadow-md p-8 text-center">
            <p className="text-gray-600 mb-4">現在、予約可能な練習枠がありません</p>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {practiceSlots.map((slot) => {
              const isAvailable = isSlotAvailable(slot)
              const remainingCapacity = getRemainingCapacity(slot)
              const isReserving = reservingSlotId === slot.id

              return (
                <div key={slot.id} className="bg-white rounded-lg shadow-md p-6">
                  <div className="mb-4">
                    <h2 className="text-xl font-semibold text-gray-900 mb-2">
                      {formatSlotDate(slot.date)}
                    </h2>
                    <p className="text-gray-600">
                      {slot.startTime} 〜 {slot.endTime}
                    </p>
                  </div>

                  <div className="mb-4 space-y-2">
                    <div className="flex justify-between">
                      <span className="text-gray-600">定員:</span>
                      <span className="font-semibold">{slot.capacity}名</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">予約数:</span>
                      <span className="font-semibold">{slot.currentBookings}名</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">空き枠:</span>
                      <span className={`font-semibold ${remainingCapacity > 0 ? 'text-green-600' : 'text-red-600'}`}>
                        {remainingCapacity}名
                      </span>
                    </div>
                    <div className="flex justify-between items-center">
                      <span className="text-gray-600">ステータス:</span>
                      <span className={`px-2 py-1 rounded-full text-xs font-semibold ${SlotStatusBadgeClasses[slot.status]}`}>
                        {SlotStatusLabels[slot.status]}
                      </span>
                    </div>
                  </div>

                  {slot.notes && (
                    <div className="mb-4">
                      <p className="text-sm text-gray-500">{slot.notes}</p>
                    </div>
                  )}

                  <Button
                    onClick={() => handleReserve(slot.id)}
                    disabled={!isAvailable || isReserving}
                    className="w-full"
                  >
                    {isReserving ? '予約中...' : isAvailable ? '予約する' : '予約不可'}
                  </Button>
                </div>
              )
            })}
          </div>
        )}
      </div>
    </div>
  )
}
```

**コードの説明**:
- `'use client'`: クライアントコンポーネントであることを示す
- `useState`: 状態管理（練習枠一覧、読み込み中、エラー、予約中）
- `useEffect`: ページ読み込み時に練習枠一覧を取得
- `fetch('/api/practice-slots?status=OPEN')`: 予約可能な練習枠のみを取得
- `isSlotAvailable`: 予約可能かどうかを判定する関数
- `getRemainingCapacity`: 空き枠数を計算する関数
- `handleReserve`: 予約ボタンクリック時に実行される関数

**現在の状態**: ✅ 練習一覧ページが実装されました

---

## ✅ ステップ3: 予約一覧ページの実装

### 3-1. 予約一覧ページとは？

**予約一覧ページ**: 会員が予約した練習の一覧を表示するページです。予約の確認やキャンセルができます。

**表示する情報**:
- 練習日
- 開始時間・終了時間
- 予約日時
- キャンセルボタン

---

### 3-2. 予約一覧ページの作成

**目的**: 会員の予約一覧を表示し、キャンセルボタンを配置します。

**手順**:

1. **予約一覧ページを作成**
   - `frontend/app/member/reservations/page.tsx` を作成

2. **以下のコードを追加**

```typescript
'use client'

import { useEffect, useState } from 'react'
import { useSession } from 'next-auth/react'
import { useRouter } from 'next/navigation'
import Button from '@/components/Button'
import { formatSlotDate } from '@/types/practice-slot'

type Reservation = {
  id: string
  status: string
  createdAt: string
  cancelledAt: string | null
  practiceSlot: {
    id: string
    date: string
    startTime: string
    endTime: string
    capacity: number
    currentBookings: number
    status: string
    notes: string | null
  }
}

export default function ReservationsListPage() {
  const { data: session } = useSession()
  const router = useRouter()
  const [reservations, setReservations] = useState<Reservation[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [cancellingReservationId, setCancellingReservationId] = useState<string | null>(null)

  useEffect(() => {
    if (session?.user?.dbId) {
      fetchReservations()
    }
  }, [session])

  const fetchReservations = async () => {
    try {
      setLoading(true)
      const response = await fetch('/api/reservations')
      const data = await response.json()

      if (!response.ok) {
        throw new Error(data.error || '予約一覧の取得に失敗しました')
      }

      setReservations(data.reservations || [])
    } catch (error) {
      console.error('予約一覧取得エラー:', error)
      setError(error instanceof Error ? error.message : '予約一覧の取得に失敗しました')
    } finally {
      setLoading(false)
    }
  }

  const handleCancel = async (reservationId: string) => {
    if (!confirm('この予約をキャンセルしますか？')) {
      return
    }

    try {
      setCancellingReservationId(reservationId)

      const response = await fetch(`/api/reservations/${reservationId}`, {
        method: 'DELETE',
      })

      const data = await response.json()

      if (!response.ok) {
        throw new Error(data.error || '予約のキャンセルに失敗しました')
      }

      alert('予約をキャンセルしました')
      // 一覧を再取得
      fetchReservations()
    } catch (error) {
      console.error('予約キャンセルエラー:', error)
      alert(error instanceof Error ? error.message : '予約のキャンセルに失敗しました')
    } finally {
      setCancellingReservationId(null)
    }
  }

  const formatDateTime = (dateString: string) => {
    const date = new Date(dateString)
    return date.toLocaleString('ja-JP', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    })
  }

  if (!session?.user?.dbId) {
    return (
      <div className="container mx-auto px-4 py-16">
        <div className="max-w-6xl mx-auto text-center">
          <p className="text-gray-600">ログインが必要です</p>
          <Button onClick={() => router.push('/login')} className="mt-4">
            ログインページへ
          </Button>
        </div>
      </div>
    )
  }

  if (loading) {
    return (
      <div className="container mx-auto px-4 py-16">
        <div className="max-w-6xl mx-auto text-center">
          <div className="text-gray-600">読み込み中...</div>
        </div>
      </div>
    )
  }

  if (error) {
    return (
      <div className="container mx-auto px-4 py-16">
        <div className="max-w-6xl mx-auto">
          <div className="bg-red-50 border border-red-200 rounded-lg p-4">
            <p className="text-red-600">{error}</p>
            <Button onClick={fetchReservations} className="mt-4">
              再読み込み
            </Button>
          </div>
        </div>
      </div>
    )
  }

  return (
    <div className="container mx-auto px-4 py-16">
      <div className="max-w-6xl mx-auto">
        <div className="mb-8">
          <h1 className="text-2xl md:text-3xl font-bold text-gray-900 mb-2">
            予約一覧
          </h1>
          <p className="text-gray-600">
            あなたの予約を確認・管理できます
          </p>
        </div>

        {reservations.length === 0 ? (
          <div className="bg-white rounded-lg shadow-md p-8 text-center">
            <p className="text-gray-600 mb-4">予約がありません</p>
            <Button onClick={() => router.push('/member/practice-slots')}>
              練習一覧を見る
            </Button>
          </div>
        ) : (
          <div className="space-y-4">
            {reservations.map((reservation) => {
              const isCancelling = cancellingReservationId === reservation.id
              const slotDate = new Date(reservation.practiceSlot.date)
              const today = new Date()
              today.setHours(0, 0, 0, 0)
              slotDate.setHours(0, 0, 0, 0)
              const isPast = slotDate < today

              return (
                <div key={reservation.id} className="bg-white rounded-lg shadow-md p-6">
                  <div className="flex justify-between items-start mb-4">
                    <div>
                      <h2 className="text-xl font-semibold text-gray-900 mb-2">
                        {formatSlotDate(reservation.practiceSlot.date)}
                      </h2>
                      <p className="text-gray-600">
                        {reservation.practiceSlot.startTime} 〜 {reservation.practiceSlot.endTime}
                      </p>
                    </div>
                    {!isPast && (
                      <Button
                        onClick={() => handleCancel(reservation.id)}
                        disabled={isCancelling}
                        variant="outline"
                        className="text-red-600 border-red-600 hover:bg-red-50"
                      >
                        {isCancelling ? 'キャンセル中...' : 'キャンセル'}
                      </Button>
                    )}
                  </div>

                  <div className="space-y-2 text-sm text-gray-600">
                    <div>
                      <span className="font-semibold">予約日時:</span>{' '}
                      {formatDateTime(reservation.createdAt)}
                    </div>
                    {reservation.practiceSlot.notes && (
                      <div>
                        <span className="font-semibold">備考:</span>{' '}
                        {reservation.practiceSlot.notes}
                      </div>
                    )}
                  </div>
                </div>
              )
            })}
          </div>
        )}
      </div>
    </div>
  )
}
```

**コードの説明**:
- `useSession`: ログイン状態を確認
- `fetch('/api/reservations')`: 自分の予約一覧を取得
- `handleCancel`: キャンセルボタンクリック時に実行される関数
- 過去の練習: 過去の練習はキャンセルボタンを表示しない

**現在の状態**: ✅ 予約一覧ページが実装されました

---

## ✅ ステップ4: 空き状況の計算ロジック

### 4-1. 空き状況の計算とは？

**空き状況の計算**: 練習枠に空きがあるかどうかを計算するロジックです。

**計算方法**:
- 空き枠 = 定員 - 現在の予約数
- 予約可能 = 空き枠 > 0 かつ ステータスが`OPEN`

---

### 4-2. 空き状況計算関数の確認

**目的**: 既存の型定義ファイルに空き状況を計算する関数があるか確認します。

**手順**:

1. **型定義ファイルを確認**
   - `frontend/types/practice-slot.ts` を確認

2. **既に実装されている関数を確認**
   - `isSlotAvailable`: 予約可能かどうかを判定
   - `getRemainingCapacity`: 空き枠数を計算

これらの関数は既に実装されているため、そのまま使用できます。

**現在の状態**: ✅ 空き状況の計算ロジックは既に実装されています

---

## ✅ ステップ5: 動作確認

### 5-1. 開発サーバーの起動

**手順**:

1. **開発サーバーを起動**
   ```bash
   cd frontend
   npm run dev
   ```

2. **起動を確認**
   - `- Local: http://localhost:3000` と表示されれば成功

---

### 5-2. 練習一覧ページの確認

**手順**:

1. **練習一覧ページにアクセス**
   - ブラウザで `http://localhost:3000/member/practice-slots` にアクセス
   - ログインが必要な場合は、ログインページにリダイレクトされます

2. **ページが表示されることを確認**
   - 「練習一覧」というタイトルが表示される
   - 予約可能な練習枠がカード形式で表示される
   - 各カードに「予約する」ボタンが表示される

---

### 5-3. 予約機能の確認

**手順**:

1. **予約ボタンをクリック**
   - 練習一覧で「予約する」ボタンをクリック

2. **確認ダイアログが表示されることを確認**
   - 「この練習枠を予約しますか？」というメッセージが表示される

3. **予約を実行**
   - 「OK」をクリック
   - 「予約が完了しました」というメッセージが表示されることを確認

4. **練習枠の予約数が更新されることを確認**
   - 練習一覧ページで、予約した練習枠の予約数が増えていることを確認
   - 空き枠が減っていることを確認

---

### 5-4. 予約一覧ページの確認

**手順**:

1. **予約一覧ページにアクセス**
   - ブラウザで `http://localhost:3000/member/reservations` にアクセス

2. **予約が表示されることを確認**
   - 予約した練習が一覧に表示される
   - 練習日、時間、予約日時が表示される

3. **キャンセルボタンが表示されることを確認**
   - 各予約に「キャンセル」ボタンが表示される

---

### 5-5. キャンセル機能の確認

**手順**:

1. **キャンセルボタンをクリック**
   - 予約一覧で「キャンセル」ボタンをクリック

2. **確認ダイアログが表示されることを確認**
   - 「この予約をキャンセルしますか？」というメッセージが表示される

3. **キャンセルを実行**
   - 「OK」をクリック
   - 「予約をキャンセルしました」というメッセージが表示されることを確認

4. **予約が削除されることを確認**
   - 予約一覧から、キャンセルした予約が消えることを確認

5. **練習枠の予約数が更新されることを確認**
   - 練習一覧ページで、キャンセルした練習枠の予約数が減っていることを確認
   - 空き枠が増えていることを確認

---

## ✅ 完了チェックリスト

以下の項目を確認して、すべて完了したら時間予約機能（2）＋（3）が完了です！

- [ ] 予約APIエンドポイントが実装されている（GET, POST, DELETE）
- [ ] 練習一覧ページが表示される
- [ ] 予約一覧ページが表示される
- [ ] 練習枠を予約できる
- [ ] 予約をキャンセルできる
- [ ] 空き状況が正しく表示される
- [ ] 予約制約が正しく動作する（重複予約の防止、予約上限数など）
- [ ] 練習枠の予約数が正しく更新される
- [ ] 満席になった練習枠のステータスが`FULL`に更新される
- [ ] キャンセルで空きが出た練習枠のステータスが`OPEN`に更新される
- [ ] 動作確認が完了している

---

## 📝 次のステップ

次回の作業内容：
- 決済機能の実装
- 通知機能の実装

詳細は `開発スケジュール.md` を参照してください。

---

## ⚠️ トラブルシューティング

### エラー1: 予約一覧が取得できない

**エラーメッセージ例**:
```
予約一覧の取得に失敗しました
```

**原因**: データベースの`reservations`テーブルが存在しない、またはAPIエンドポイントが正しく実装されていない。

**解決方法**:

1. **データベーステーブルを確認**
   - Supabaseのダッシュボードで`reservations`テーブルが存在するか確認
   - Prismaスキーマを確認して、マイグレーションが実行されているか確認

2. **APIエンドポイントを確認**
   - `frontend/app/api/reservations/route.ts`が正しく実装されているか確認
   - ブラウザの開発者ツールでネットワークタブを確認し、APIリクエストが正しく送信されているか確認

---

### エラー2: 予約が失敗する

**エラーメッセージ例**:
```
予約の作成に失敗しました
```

**原因**: 予約制約に引っかかっている、またはデータベースエラー。

**解決方法**:

1. **予約制約を確認**
   - 練習枠のステータスが`OPEN`か確認
   - 空きがあるか確認
   - 既に予約していないか確認
   - 予約上限数に達していないか確認

2. **エラーログを確認**
   - ターミナルに表示されるエラーメッセージを確認
   - ブラウザの開発者ツールのコンソールを確認

---

### エラー3: キャンセルが失敗する

**エラーメッセージ例**:
```
予約のキャンセルに失敗しました
```

**原因**: 予約が見つからない、またはデータベースエラー。

**解決方法**:

1. **予約IDを確認**
   - URLの`[id]`部分が正しいか確認
   - 予約一覧ページで、キャンセルボタンのリンクが正しいか確認

2. **データベースを確認**
   - Supabaseのダッシュボードで、該当する予約が存在するか確認
   - 予約のステータスが`active`か確認

---

### エラー4: 練習枠の予約数が更新されない

**原因**: 予約作成・キャンセル時に練習枠の更新処理が失敗している。

**解決方法**:

1. **エラーログを確認**
   - ターミナルに表示されるエラーメッセージを確認
   - 「練習枠の更新に失敗しました」というメッセージが出ていないか確認

2. **データベースを確認**
   - Supabaseのダッシュボードで、練習枠の`current_reservations`が正しく更新されているか確認

---

## 💡 よくある質問（FAQ）

### Q1: 予約上限数は変更できますか？

**A**: はい。`frontend/app/api/reservations/route.ts`の`MAX_RESERVATIONS`定数を変更することで、予約上限数を変更できます。

```typescript
const MAX_RESERVATIONS = 5 // 例: 5件に変更
```

---

### Q2: 過去の練習も予約できますか？

**A**: 現在の実装では、練習一覧ページで未来の日付の練習枠のみを表示しています。過去の練習は表示されないため、予約できません。

---

### Q3: キャンセルした予約は表示されますか？

**A**: 現在の実装では、有効な予約（`status = 'active'`）のみを表示しています。キャンセルした予約は表示されません。必要に応じて、キャンセル済みの予約も表示する機能を追加できます。

---

### Q4: 予約締切日時を設定できますか？

**A**: 現在の実装では、予約締切日時の機能は実装していません。必要に応じて、練習枠に`deadline`カラムを追加し、予約時に締切をチェックする機能を追加できます。

---

### Q5: 複数の練習枠を一度に予約できますか？

**A**: 現在の実装では、1つずつ予約する必要があります。複数の練習枠を一度に予約する機能が必要な場合は、追加実装が必要です。

---

## 📞 参考リンク

- **Next.js公式ドキュメント**: https://nextjs.org/docs
- **Supabase公式ドキュメント**: https://supabase.com/docs
- **Prisma公式ドキュメント**: https://www.prisma.io/docs
- **TypeScript公式ドキュメント**: https://www.typescriptlang.org/docs

---

**最終更新**: 2026年2月16日  
**対象**: プログラミング初心者の方
