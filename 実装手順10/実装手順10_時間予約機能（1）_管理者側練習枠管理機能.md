# 時間予約機能（1） 実装手順（初心者向け）

## 📚 このガイドについて

このガイドは、**2/15（日）: 時間予約機能（1）**の作業を初心者の方でも理解できるように、**用語の説明**や**各ステップの詳細**を丁寧に記載しています。

**所要時間**: 約4〜5時間（初めての場合）

---

## 📖 用語集（最初に読んでおくと理解が深まります）

### 練習枠管理に関する用語

- **練習枠**: 練習の日時と定員を管理するデータ。1つの練習枠に対して、複数の会員が予約できます
- **定員**: 1つの練習枠に参加できる最大人数
- **現在の予約数**: 現在、その練習枠に予約している人数
- **ステータス**: 練習枠の状態を表す値（OPEN: 受付中、FULL: 満席、CLOSED: 受付終了、CANCELLED: 中止）
- **管理者側**: サッカー教室の管理者が使用する機能。練習枠の作成・編集・削除ができます

### APIに関する用語

- **API**: アプリケーションとデータベースの間でデータをやり取りする仕組み
- **GET**: データを取得するリクエスト
- **POST**: 新しいデータを作成するリクエスト
- **PUT**: 既存のデータを更新するリクエスト
- **DELETE**: データを削除するリクエスト
- **エンドポイント**: APIのURL（例: `/api/practice-slots`）

### フォームに関する用語

- **フォーム**: ユーザーが入力する画面（練習枠の登録画面など）
- **バリデーション**: 入力されたデータが正しいかチェックすること
- **必須項目**: 入力が必須の項目（練習日、開始時間、終了時間、定員など）

---

## 📋 今日（2/15）の作業内容

開発スケジュールの「2/15（日）: 時間予約機能（1）」を完了するためのステップバイステップガイドです。

**目標**: 管理者が練習枠を登録・一覧表示・編集・削除できる機能を実装する

**作成・更新するもの**:
1. 練習枠一覧ページ（`/admin/practice-slots`）
2. 練習枠登録ページ（`/admin/practice-slots/new`）
3. 練習枠編集ページ（`/admin/practice-slots/[id]/edit`）
4. 練習枠管理用のAPIエンドポイント（`/api/practice-slots`）

---

## ✅ ステップ1: APIエンドポイントの実装

### 1-1. APIエンドポイントとは？

**APIエンドポイント**: フロントエンド（画面）とデータベースの間でデータをやり取りする仕組みです。

**今回作成するAPIエンドポイント**:
- `GET /api/practice-slots`: 練習枠一覧を取得
- `POST /api/practice-slots`: 新しい練習枠を作成
- `GET /api/practice-slots/[id]`: 特定の練習枠の詳細を取得
- `PUT /api/practice-slots/[id]`: 練習枠を更新
- `DELETE /api/practice-slots/[id]`: 練習枠を削除

---

### 1-2. 練習枠一覧取得APIの実装

**目的**: データベースから練習枠の一覧を取得するAPIを作成します。

**手順**:

1. **APIルートファイルを作成**
   - `frontend/app/api/practice-slots/route.ts` を作成

2. **以下のコードを追加**

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { supabaseAdmin } from '@/lib/supabase-admin'
import { auth } from '@/app/api/auth/[...nextauth]/route'

// 練習枠一覧を取得
export async function GET(request: NextRequest) {
  try {
    // セッション情報を取得（ログインしているユーザーを確認）
    const session = await auth()
    
    if (!session?.user?.dbId) {
      return NextResponse.json(
        { error: 'ログインが必要です' },
        { status: 401 }
      )
    }

    // クエリパラメータを取得（日付範囲やステータスでフィルター可能）
    const { searchParams } = new URL(request.url)
    const dateFrom = searchParams.get('dateFrom')
    const dateTo = searchParams.get('dateTo')
    const status = searchParams.get('status')

    // データベースから練習枠一覧を取得
    let query = supabaseAdmin
      .from('practice_slots')
      .select('*')
      .order('date', { ascending: true })
      .order('start_time', { ascending: true })

    // 日付範囲でフィルター
    if (dateFrom) {
      query = query.gte('date', dateFrom)
    }
    if (dateTo) {
      query = query.lte('date', dateTo)
    }
    if (status) {
      query = query.eq('status', status)
    }

    const { data, error } = await query

    if (error) {
      console.error('データベース取得エラー:', error)
      return NextResponse.json(
        { error: '練習枠一覧の取得に失敗しました' },
        { status: 500 }
      )
    }

    // データ形式を変換（スネークケース → キャメルケース）
    const practiceSlots = (data || []).map((slot) => ({
      id: slot.id,
      date: slot.date,
      startTime: slot.start_time,
      endTime: slot.end_time,
      capacity: slot.capacity,
      currentBookings: slot.current_bookings,
      status: slot.status,
      notes: slot.notes,
      createdAt: slot.created_at,
      updatedAt: slot.updated_at,
    }))

    return NextResponse.json({ practiceSlots })
  } catch (error) {
    console.error('練習枠一覧取得エラー:', error)
    return NextResponse.json(
      { error: '練習枠一覧の取得中にエラーが発生しました' },
      { status: 500 }
    )
  }
}
```

**コードの説明**:
- `GET`: HTTPメソッドで、データを取得する際に使用
- `auth()`: ログインしているユーザーを確認
- `supabaseAdmin.from('practice_slots')`: `practice_slots`テーブルからデータを取得
- `.select('*')`: すべてのカラムを取得
- `.order('date')`: 日付順に並び替え
- `.gte('date', dateFrom)`: 日付が`dateFrom`以降のデータを取得
- `.lte('date', dateTo)`: 日付が`dateTo`以前のデータを取得
- `.eq('status', status)`: ステータスが一致するデータを取得

**現在の状態**: ✅ 練習枠一覧取得APIが実装されました

---

### 1-3. 練習枠作成APIの実装

**目的**: 新しい練習枠をデータベースに保存するAPIを作成します。

**手順**:

1. **同じファイルにPOST関数を追加**
   - `frontend/app/api/practice-slots/route.ts` に以下を追加

```typescript
// 新しい練習枠を作成
export async function POST(request: NextRequest) {
  try {
    // セッション情報を取得（ログインしているユーザーを確認）
    const session = await auth()
    
    if (!session?.user?.dbId) {
      return NextResponse.json(
        { error: 'ログインが必要です' },
        { status: 401 }
      )
    }

    // リクエストボディからフォームデータを取得
    const body = await request.json()
    const {
      date,
      startTime,
      endTime,
      capacity,
      notes,
    } = body

    // バリデーション（必須項目のチェック）
    if (!date || !startTime || !endTime || !capacity) {
      return NextResponse.json(
        { error: '必須項目が入力されていません' },
        { status: 400 }
      )
    }

    // 定員が正の数かチェック
    if (capacity <= 0) {
      return NextResponse.json(
        { error: '定員は1以上である必要があります' },
        { status: 400 }
      )
    }

    // 時間形式のチェック（HH:MM形式）
    const timePattern = /^([0-1][0-9]|2[0-3]):[0-5][0-9]$/
    if (!timePattern.test(startTime) || !timePattern.test(endTime)) {
      return NextResponse.json(
        { error: '時間はHH:MM形式で入力してください' },
        { status: 400 }
      )
    }

    // 終了時間が開始時間より後かチェック
    const [startHour, startMinute] = startTime.split(':').map(Number)
    const [endHour, endMinute] = endTime.split(':').map(Number)
    const startMinutes = startHour * 60 + startMinute
    const endMinutes = endHour * 60 + endMinute
    
    if (endMinutes <= startMinutes) {
      return NextResponse.json(
        { error: '終了時間は開始時間より後である必要があります' },
        { status: 400 }
      )
    }

    // データベースに保存（スネークケースに変換）
    const { data, error } = await supabaseAdmin
      .from('practice_slots')
      .insert({
        date: date,
        start_time: startTime,
        end_time: endTime,
        capacity: capacity,
        current_bookings: 0, // 初期値は0
        status: 'OPEN', // 初期状態は「受付中」
        notes: notes || null,
      })
      .select()
      .single()

    if (error) {
      console.error('データベース保存エラー:', error)
      return NextResponse.json(
        { 
          error: '練習枠の保存に失敗しました',
          details: error.message || 'データベースエラーが発生しました'
        },
        { status: 500 }
      )
    }

    // 成功レスポンス（キャメルケースに変換）
    const practiceSlot = {
      id: data.id,
      date: data.date,
      startTime: data.start_time,
      endTime: data.end_time,
      capacity: data.capacity,
      currentBookings: data.current_bookings,
      status: data.status,
      notes: data.notes,
      createdAt: data.created_at,
      updatedAt: data.updated_at,
    }

    return NextResponse.json(
      { 
        success: true,
        practiceSlot
      },
      { status: 201 }
    )
  } catch (error) {
    console.error('練習枠作成エラー:', error)
    return NextResponse.json(
      { error: '練習枠作成中にエラーが発生しました' },
      { status: 500 }
    )
  }
}
```

**コードの説明**:
- `POST`: HTTPメソッドで、新しいデータを作成する際に使用
- `request.json()`: リクエストボディからJSONデータを取得
- バリデーション: 入力データが正しいかチェック（必須項目、定員、時間形式など）
- `.insert()`: データベースに新しいレコードを追加
- `.select().single()`: 作成されたデータを取得

**現在の状態**: ✅ 練習枠作成APIが実装されました

---

### 1-4. 練習枠詳細取得・更新・削除APIの実装

**目的**: 特定の練習枠の詳細を取得・更新・削除するAPIを作成します。

**手順**:

1. **APIルートファイルを作成**
   - `frontend/app/api/practice-slots/[id]/route.ts` を作成

2. **以下のコードを追加**

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { supabaseAdmin } from '@/lib/supabase-admin'
import { auth } from '@/app/api/auth/[...nextauth]/route'

// 特定の練習枠の詳細を取得
export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    // セッション情報を取得
    const session = await auth()
    
    if (!session?.user?.dbId) {
      return NextResponse.json(
        { error: 'ログインが必要です' },
        { status: 401 }
      )
    }

    const { id } = params

    // データベースから練習枠を取得
    const { data, error } = await supabaseAdmin
      .from('practice_slots')
      .select('*')
      .eq('id', id)
      .single()

    if (error) {
      console.error('データベース取得エラー:', error)
      return NextResponse.json(
        { error: '練習枠の取得に失敗しました' },
        { status: 500 }
      )
    }

    if (!data) {
      return NextResponse.json(
        { error: '練習枠が見つかりません' },
        { status: 404 }
      )
    }

    // データ形式を変換
    const practiceSlot = {
      id: data.id,
      date: data.date,
      startTime: data.start_time,
      endTime: data.end_time,
      capacity: data.capacity,
      currentBookings: data.current_bookings,
      status: data.status,
      notes: data.notes,
      createdAt: data.created_at,
      updatedAt: data.updated_at,
    }

    return NextResponse.json({ practiceSlot })
  } catch (error) {
    console.error('練習枠取得エラー:', error)
    return NextResponse.json(
      { error: '練習枠の取得中にエラーが発生しました' },
      { status: 500 }
    )
  }
}

// 練習枠を更新
export async function PUT(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    // セッション情報を取得
    const session = await auth()
    
    if (!session?.user?.dbId) {
      return NextResponse.json(
        { error: 'ログインが必要です' },
        { status: 401 }
      )
    }

    const { id } = params
    const body = await request.json()
    const {
      date,
      startTime,
      endTime,
      capacity,
      status,
      notes,
    } = body

    // バリデーション
    if (capacity !== undefined && capacity <= 0) {
      return NextResponse.json(
        { error: '定員は1以上である必要があります' },
        { status: 400 }
      )
    }

    // 時間形式のチェック
    if (startTime || endTime) {
      const timePattern = /^([0-1][0-9]|2[0-3]):[0-5][0-9]$/
      if (startTime && !timePattern.test(startTime)) {
        return NextResponse.json(
          { error: '開始時間はHH:MM形式で入力してください' },
          { status: 400 }
        )
      }
      if (endTime && !timePattern.test(endTime)) {
        return NextResponse.json(
          { error: '終了時間はHH:MM形式で入力してください' },
          { status: 400 }
        )
      }
    }

    // 更新するデータを準備（スネークケースに変換）
    const updateData: any = {}
    if (date !== undefined) updateData.date = date
    if (startTime !== undefined) updateData.start_time = startTime
    if (endTime !== undefined) updateData.end_time = endTime
    if (capacity !== undefined) updateData.capacity = capacity
    if (status !== undefined) updateData.status = status
    if (notes !== undefined) updateData.notes = notes

    // データベースを更新
    const { data, error } = await supabaseAdmin
      .from('practice_slots')
      .update(updateData)
      .eq('id', id)
      .select()
      .single()

    if (error) {
      console.error('データベース更新エラー:', error)
      return NextResponse.json(
        { 
          error: '練習枠の更新に失敗しました',
          details: error.message || 'データベースエラーが発生しました'
        },
        { status: 500 }
      )
    }

    if (!data) {
      return NextResponse.json(
        { error: '練習枠が見つかりません' },
        { status: 404 }
      )
    }

    // データ形式を変換
    const practiceSlot = {
      id: data.id,
      date: data.date,
      startTime: data.start_time,
      endTime: data.end_time,
      capacity: data.capacity,
      currentBookings: data.current_bookings,
      status: data.status,
      notes: data.notes,
      createdAt: data.created_at,
      updatedAt: data.updated_at,
    }

    return NextResponse.json({ 
      success: true,
      practiceSlot 
    })
  } catch (error) {
    console.error('練習枠更新エラー:', error)
    return NextResponse.json(
      { error: '練習枠更新中にエラーが発生しました' },
      { status: 500 }
    )
  }
}

// 練習枠を削除
export async function DELETE(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    // セッション情報を取得
    const session = await auth()
    
    if (!session?.user?.dbId) {
      return NextResponse.json(
        { error: 'ログインが必要です' },
        { status: 401 }
      )
    }

    const { id } = params

    // データベースから削除
    const { error } = await supabaseAdmin
      .from('practice_slots')
      .delete()
      .eq('id', id)

    if (error) {
      console.error('データベース削除エラー:', error)
      return NextResponse.json(
        { error: '練習枠の削除に失敗しました' },
        { status: 500 }
      )
    }

    return NextResponse.json({ 
      success: true,
      message: '練習枠を削除しました'
    })
  } catch (error) {
    console.error('練習枠削除エラー:', error)
    return NextResponse.json(
      { error: '練習枠削除中にエラーが発生しました' },
      { status: 500 }
    )
  }
}
```

**コードの説明**:
- `[id]`: 動的ルートパラメータ。URLの`/api/practice-slots/123`の`123`が`id`として取得できる
- `params`: 動的ルートパラメータを取得するオブジェクト
- `.eq('id', id)`: IDが一致するレコードを取得・更新・削除
- `.update()`: データベースのレコードを更新
- `.delete()`: データベースのレコードを削除

**現在の状態**: ✅ 練習枠詳細取得・更新・削除APIが実装されました

---

## ✅ ステップ2: 練習枠一覧ページの実装

### 2-1. 練習枠一覧ページとは？

**練習枠一覧ページ**: 登録されているすべての練習枠を一覧表示するページです。管理者が練習枠の状況を確認できます。

**表示する情報**:
- 練習日
- 開始時間・終了時間
- 定員・現在の予約数
- ステータス
- 操作ボタン（編集・削除）

---

### 2-2. 練習枠一覧ページの作成

**目的**: 練習枠の一覧を表示し、編集・削除ボタンを配置します。

**手順**:

1. **練習枠一覧ページを作成**
   - `frontend/app/admin/practice-slots/page.tsx` を作成

2. **以下のコードを追加**

```typescript
'use client'

import { useEffect, useState } from 'react'
import Link from 'next/link'
import Button from '@/components/Button'
import { PracticeSlot, SlotStatusLabels, SlotStatusBadgeClasses } from '@/types/practice-slot'

export default function PracticeSlotsListPage() {
  const [practiceSlots, setPracticeSlots] = useState<PracticeSlot[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    fetchPracticeSlots()
  }, [])

  const fetchPracticeSlots = async () => {
    try {
      setLoading(true)
      const response = await fetch('/api/practice-slots')
      const data = await response.json()

      if (!response.ok) {
        throw new Error(data.error || '練習枠一覧の取得に失敗しました')
      }

      setPracticeSlots(data.practiceSlots || [])
    } catch (error) {
      console.error('練習枠一覧取得エラー:', error)
      setError(error instanceof Error ? error.message : '練習枠一覧の取得に失敗しました')
    } finally {
      setLoading(false)
    }
  }

  const handleDelete = async (id: string) => {
    if (!confirm('この練習枠を削除しますか？関連する予約も削除されます。')) {
      return
    }

    try {
      const response = await fetch(`/api/practice-slots/${id}`, {
        method: 'DELETE',
      })

      const data = await response.json()

      if (!response.ok) {
        throw new Error(data.error || '練習枠の削除に失敗しました')
      }

      // 一覧を再取得
      fetchPracticeSlots()
      alert('練習枠を削除しました')
    } catch (error) {
      console.error('練習枠削除エラー:', error)
      alert(error instanceof Error ? error.message : '練習枠の削除に失敗しました')
    }
  }

  const formatDate = (dateString: string) => {
    const date = new Date(dateString)
    return date.toLocaleDateString('ja-JP', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      weekday: 'short',
    })
  }

  if (loading) {
    return (
      <div className="container mx-auto px-4 py-16">
        <div className="max-w-6xl mx-auto text-center">
          <div className="text-gray-600">読み込み中...</div>
        </div>
      </div>
    )
  }

  if (error) {
    return (
      <div className="container mx-auto px-4 py-16">
        <div className="max-w-6xl mx-auto">
          <div className="bg-red-50 border border-red-200 rounded-lg p-4">
            <p className="text-red-600">{error}</p>
            <Button onClick={fetchPracticeSlots} className="mt-4">
              再読み込み
            </Button>
          </div>
        </div>
      </div>
    )
  }

  return (
    <div className="container mx-auto px-4 py-16">
      <div className="max-w-6xl mx-auto">
        <div className="mb-8 flex justify-between items-center">
          <div>
            <h1 className="text-2xl md:text-3xl font-bold text-gray-900 mb-2">
              練習枠一覧
            </h1>
            <p className="text-gray-600">
              すべての練習枠を確認・管理できます
            </p>
          </div>
          <Link href="/admin/practice-slots/new">
            <Button>
              新規登録
            </Button>
          </Link>
        </div>

        {practiceSlots.length === 0 ? (
          <div className="bg-white rounded-lg shadow-md p-8 text-center">
            <p className="text-gray-600 mb-4">練習枠が登録されていません</p>
            <Link href="/admin/practice-slots/new">
              <Button>最初の練習枠を登録する</Button>
            </Link>
          </div>
        ) : (
          <div className="bg-white rounded-lg shadow-md overflow-hidden">
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      練習日
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      時間
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      定員
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      予約数
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      ステータス
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      備考
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      操作
                    </th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {practiceSlots.map((slot) => (
                    <tr key={slot.id} className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {formatDate(slot.date)}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {slot.startTime} 〜 {slot.endTime}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {slot.capacity}名
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {slot.currentBookings}名
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <span className={`px-2 py-1 rounded-full text-xs font-semibold ${SlotStatusBadgeClasses[slot.status]}`}>
                          {SlotStatusLabels[slot.status]}
                        </span>
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-500">
                        {slot.notes || '-'}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        <Link
                          href={`/admin/practice-slots/${slot.id}/edit`}
                          className="text-green-600 hover:text-green-900"
                        >
                          編集
                        </Link>
                        <button
                          onClick={() => handleDelete(slot.id)}
                          className="text-red-600 hover:text-red-900"
                        >
                          削除
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}
      </div>
    </div>
  )
}
```

**コードの説明**:
- `'use client'`: クライアントコンポーネントであることを示す
- `useState`: 状態管理（練習枠一覧、読み込み中、エラー）
- `useEffect`: ページ読み込み時に練習枠一覧を取得
- `fetch('/api/practice-slots')`: APIを呼び出して練習枠一覧を取得
- `handleDelete`: 削除ボタンクリック時に実行される関数
- `confirm()`: 削除確認ダイアログを表示

**現在の状態**: ✅ 練習枠一覧ページが実装されました

---

## ✅ ステップ3: 練習枠登録ページの実装

### 3-1. 練習枠登録ページとは？

**練習枠登録ページ**: 新しい練習枠を登録するためのフォームページです。

**入力項目**:
- 練習日（必須）
- 開始時間（必須、HH:MM形式）
- 終了時間（必須、HH:MM形式）
- 定員（必須、1以上の数値）
- 備考（任意）

---

### 3-2. 練習枠登録ページの作成

**目的**: 練習枠を登録するためのフォームを作成します。

**手順**:

1. **練習枠登録ページを作成**
   - `frontend/app/admin/practice-slots/new/page.tsx` を作成

2. **以下のコードを追加**

```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import Link from 'next/link'
import Button from '@/components/Button'
import Input from '@/components/Input'

export default function NewPracticeSlotPage() {
  const router = useRouter()
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)
  
  const [formData, setFormData] = useState({
    date: '',
    startTime: '',
    endTime: '',
    capacity: '',
    notes: '',
  })

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    const { name, value } = e.target
    setFormData((prev) => ({
      ...prev,
      [name]: value,
    }))
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setError(null)

    // バリデーション
    if (!formData.date || !formData.startTime || !formData.endTime || !formData.capacity) {
      setError('必須項目が入力されていません')
      return
    }

    const capacity = parseInt(formData.capacity, 10)
    if (isNaN(capacity) || capacity <= 0) {
      setError('定員は1以上の数値を入力してください')
      return
    }

    try {
      setLoading(true)

      const response = await fetch('/api/practice-slots', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          date: formData.date,
          startTime: formData.startTime,
          endTime: formData.endTime,
          capacity: capacity,
          notes: formData.notes || null,
        }),
      })

      const data = await response.json()

      if (!response.ok) {
        throw new Error(data.error || '練習枠の登録に失敗しました')
      }

      // 成功したら一覧ページにリダイレクト
      router.push('/admin/practice-slots')
      router.refresh()
    } catch (error) {
      console.error('練習枠登録エラー:', error)
      setError(error instanceof Error ? error.message : '練習枠の登録に失敗しました')
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="container mx-auto px-4 py-16">
      <div className="max-w-2xl mx-auto">
        <div className="mb-8">
          <Link 
            href="/admin/practice-slots"
            className="text-green-600 hover:text-green-900 mb-4 inline-block"
          >
            ← 練習枠一覧に戻る
          </Link>
          <h1 className="text-2xl md:text-3xl font-bold text-gray-900 mt-4">
            練習枠を登録
          </h1>
          <p className="text-gray-600 mt-2">
            新しい練習枠の情報を入力してください
          </p>
        </div>

        <form onSubmit={handleSubmit} className="bg-white rounded-lg shadow-md p-6 md:p-8">
          {error && (
            <div className="mb-6 bg-red-50 border border-red-200 rounded-lg p-4">
              <p className="text-red-600">{error}</p>
            </div>
          )}

          <div className="space-y-6">
            <div>
              <label htmlFor="date" className="block text-sm font-medium text-gray-700 mb-2">
                練習日 <span className="text-red-500">*</span>
              </label>
              <Input
                type="date"
                id="date"
                name="date"
                value={formData.date}
                onChange={handleChange}
                required
              />
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label htmlFor="startTime" className="block text-sm font-medium text-gray-700 mb-2">
                  開始時間 <span className="text-red-500">*</span>
                </label>
                <Input
                  type="time"
                  id="startTime"
                  name="startTime"
                  value={formData.startTime}
                  onChange={handleChange}
                  required
                />
                <p className="mt-1 text-sm text-gray-500">HH:MM形式（例: 10:00）</p>
              </div>

              <div>
                <label htmlFor="endTime" className="block text-sm font-medium text-gray-700 mb-2">
                  終了時間 <span className="text-red-500">*</span>
                </label>
                <Input
                  type="time"
                  id="endTime"
                  name="endTime"
                  value={formData.endTime}
                  onChange={handleChange}
                  required
                />
                <p className="mt-1 text-sm text-gray-500">HH:MM形式（例: 12:00）</p>
              </div>
            </div>

            <div>
              <label htmlFor="capacity" className="block text-sm font-medium text-gray-700 mb-2">
                定員 <span className="text-red-500">*</span>
              </label>
              <Input
                type="number"
                id="capacity"
                name="capacity"
                value={formData.capacity}
                onChange={handleChange}
                min="1"
                required
              />
              <p className="mt-1 text-sm text-gray-500">参加できる最大人数</p>
            </div>

            <div>
              <label htmlFor="notes" className="block text-sm font-medium text-gray-700 mb-2">
                備考
              </label>
              <textarea
                id="notes"
                name="notes"
                value={formData.notes}
                onChange={handleChange}
                rows={4}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
              />
              <p className="mt-1 text-sm text-gray-500">任意のメモや注意事項</p>
            </div>
          </div>

          <div className="mt-8 flex justify-end space-x-4">
            <Link href="/admin/practice-slots">
              <Button type="button" variant="outline">
                キャンセル
              </Button>
            </Link>
            <Button type="submit" disabled={loading}>
              {loading ? '登録中...' : '登録する'}
            </Button>
          </div>
        </form>
      </div>
    </div>
  )
}
```

**コードの説明**:
- `useRouter`: Next.jsのルーターを使用してページ遷移
- `useState`: フォームデータとエラー状態を管理
- `handleChange`: 入力フィールドの値が変更された時に実行
- `handleSubmit`: フォーム送信時に実行（バリデーション → API呼び出し → リダイレクト）
- `router.push()`: 指定したページに遷移
- `router.refresh()`: ページを再読み込み

**現在の状態**: ✅ 練習枠登録ページが実装されました

---

## ✅ ステップ4: 練習枠編集ページの実装

### 4-1. 練習枠編集ページとは？

**練習枠編集ページ**: 既存の練習枠の情報を編集するページです。

**編集可能な項目**:
- 練習日
- 開始時間・終了時間
- 定員
- ステータス（OPEN/FULL/CLOSED/CANCELLED）
- 備考

---

### 4-2. 練習枠編集ページの作成

**目的**: 既存の練習枠を編集するためのフォームを作成します。

**手順**:

1. **練習枠編集ページを作成**
   - `frontend/app/admin/practice-slots/[id]/edit/page.tsx` を作成

2. **以下のコードを追加**

```typescript
'use client'

import { useState, useEffect } from 'react'
import { useRouter, useParams } from 'next/navigation'
import Link from 'next/link'
import Button from '@/components/Button'
import Input from '@/components/Input'
import { PracticeSlot, SlotStatus, SlotStatusLabels } from '@/types/practice-slot'

export default function EditPracticeSlotPage() {
  const router = useRouter()
  const params = useParams()
  const id = params.id as string

  const [loading, setLoading] = useState(true)
  const [saving, setSaving] = useState(false)
  const [error, setError] = useState<string | null>(null)
  
  const [formData, setFormData] = useState({
    date: '',
    startTime: '',
    endTime: '',
    capacity: '',
    status: 'OPEN' as SlotStatus,
    notes: '',
  })

  useEffect(() => {
    fetchPracticeSlot()
  }, [id])

  const fetchPracticeSlot = async () => {
    try {
      setLoading(true)
      const response = await fetch(`/api/practice-slots/${id}`)
      const data = await response.json()

      if (!response.ok) {
        throw new Error(data.error || '練習枠の取得に失敗しました')
      }

      const slot: PracticeSlot = data.practiceSlot
      
      // 日付をYYYY-MM-DD形式に変換
      const date = new Date(slot.date)
      const dateStr = date.toISOString().split('T')[0]

      setFormData({
        date: dateStr,
        startTime: slot.startTime,
        endTime: slot.endTime,
        capacity: slot.capacity.toString(),
        status: slot.status,
        notes: slot.notes || '',
      })
    } catch (error) {
      console.error('練習枠取得エラー:', error)
      setError(error instanceof Error ? error.message : '練習枠の取得に失敗しました')
    } finally {
      setLoading(false)
    }
  }

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value } = e.target
    setFormData((prev) => ({
      ...prev,
      [name]: value,
    }))
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setError(null)

    // バリデーション
    if (!formData.date || !formData.startTime || !formData.endTime || !formData.capacity) {
      setError('必須項目が入力されていません')
      return
    }

    const capacity = parseInt(formData.capacity, 10)
    if (isNaN(capacity) || capacity <= 0) {
      setError('定員は1以上の数値を入力してください')
      return
    }

    try {
      setSaving(true)

      const response = await fetch(`/api/practice-slots/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          date: formData.date,
          startTime: formData.startTime,
          endTime: formData.endTime,
          capacity: capacity,
          status: formData.status,
          notes: formData.notes || null,
        }),
      })

      const data = await response.json()

      if (!response.ok) {
        throw new Error(data.error || '練習枠の更新に失敗しました')
      }

      // 成功したら一覧ページにリダイレクト
      router.push('/admin/practice-slots')
      router.refresh()
    } catch (error) {
      console.error('練習枠更新エラー:', error)
      setError(error instanceof Error ? error.message : '練習枠の更新に失敗しました')
    } finally {
      setSaving(false)
    }
  }

  if (loading) {
    return (
      <div className="container mx-auto px-4 py-16">
        <div className="max-w-2xl mx-auto text-center">
          <div className="text-gray-600">読み込み中...</div>
        </div>
      </div>
    )
  }

  if (error && !formData.date) {
    return (
      <div className="container mx-auto px-4 py-16">
        <div className="max-w-2xl mx-auto">
          <div className="bg-red-50 border border-red-200 rounded-lg p-4">
            <p className="text-red-600">{error}</p>
            <Link href="/admin/practice-slots">
              <Button className="mt-4">練習枠一覧に戻る</Button>
            </Link>
          </div>
        </div>
      </div>
    )
  }

  return (
    <div className="container mx-auto px-4 py-16">
      <div className="max-w-2xl mx-auto">
        <div className="mb-8">
          <Link 
            href="/admin/practice-slots"
            className="text-green-600 hover:text-green-900 mb-4 inline-block"
          >
            ← 練習枠一覧に戻る
          </Link>
          <h1 className="text-2xl md:text-3xl font-bold text-gray-900 mt-4">
            練習枠を編集
          </h1>
          <p className="text-gray-600 mt-2">
            練習枠の情報を編集できます
          </p>
        </div>

        <form onSubmit={handleSubmit} className="bg-white rounded-lg shadow-md p-6 md:p-8">
          {error && (
            <div className="mb-6 bg-red-50 border border-red-200 rounded-lg p-4">
              <p className="text-red-600">{error}</p>
            </div>
          )}

          <div className="space-y-6">
            <div>
              <label htmlFor="date" className="block text-sm font-medium text-gray-700 mb-2">
                練習日 <span className="text-red-500">*</span>
              </label>
              <Input
                type="date"
                id="date"
                name="date"
                value={formData.date}
                onChange={handleChange}
                required
              />
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label htmlFor="startTime" className="block text-sm font-medium text-gray-700 mb-2">
                  開始時間 <span className="text-red-500">*</span>
                </label>
                <Input
                  type="time"
                  id="startTime"
                  name="startTime"
                  value={formData.startTime}
                  onChange={handleChange}
                  required
                />
              </div>

              <div>
                <label htmlFor="endTime" className="block text-sm font-medium text-gray-700 mb-2">
                  終了時間 <span className="text-red-500">*</span>
                </label>
                <Input
                  type="time"
                  id="endTime"
                  name="endTime"
                  value={formData.endTime}
                  onChange={handleChange}
                  required
                />
              </div>
            </div>

            <div>
              <label htmlFor="capacity" className="block text-sm font-medium text-gray-700 mb-2">
                定員 <span className="text-red-500">*</span>
              </label>
              <Input
                type="number"
                id="capacity"
                name="capacity"
                value={formData.capacity}
                onChange={handleChange}
                min="1"
                required
              />
            </div>

            <div>
              <label htmlFor="status" className="block text-sm font-medium text-gray-700 mb-2">
                ステータス <span className="text-red-500">*</span>
              </label>
              <select
                id="status"
                name="status"
                value={formData.status}
                onChange={handleChange}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                required
              >
                <option value="OPEN">受付中</option>
                <option value="FULL">満席</option>
                <option value="CLOSED">受付終了</option>
                <option value="CANCELLED">中止</option>
              </select>
            </div>

            <div>
              <label htmlFor="notes" className="block text-sm font-medium text-gray-700 mb-2">
                備考
              </label>
              <textarea
                id="notes"
                name="notes"
                value={formData.notes}
                onChange={handleChange}
                rows={4}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
              />
            </div>
          </div>

          <div className="mt-8 flex justify-end space-x-4">
            <Link href="/admin/practice-slots">
              <Button type="button" variant="outline">
                キャンセル
              </Button>
            </Link>
            <Button type="submit" disabled={saving}>
              {saving ? '更新中...' : '更新する'}
            </Button>
          </div>
        </form>
      </div>
    </div>
  )
}
```

**コードの説明**:
- `useParams`: 動的ルートパラメータ（`[id]`）を取得
- `useEffect`: ページ読み込み時に練習枠の詳細を取得
- `fetchPracticeSlot`: APIを呼び出して練習枠の詳細を取得
- 日付の変換: `new Date(slot.date).toISOString().split('T')[0]`でYYYY-MM-DD形式に変換

**現在の状態**: ✅ 練習枠編集ページが実装されました

---

## ✅ ステップ5: 動作確認

### 5-1. 開発サーバーの起動

**手順**:

1. **開発サーバーを起動**
   ```bash
   cd frontend
   npm run dev
   ```

2. **起動を確認**
   - `- Local: http://localhost:3000` と表示されれば成功

---

### 5-2. 練習枠一覧ページの確認

**手順**:

1. **練習枠一覧ページにアクセス**
   - ブラウザで `http://localhost:3000/admin/practice-slots` にアクセス
   - ログインが必要な場合は、ログインページにリダイレクトされます

2. **ページが表示されることを確認**
   - 「練習枠一覧」というタイトルが表示される
   - 「新規登録」ボタンが表示される
   - 練習枠が登録されていない場合は「練習枠が登録されていません」と表示される

---

### 5-3. 練習枠登録の確認

**手順**:

1. **練習枠登録ページにアクセス**
   - 「新規登録」ボタンをクリック
   - または `http://localhost:3000/admin/practice-slots/new` に直接アクセス

2. **フォームに入力**
   - 練習日: 2026-02-20（例）
   - 開始時間: 10:00
   - 終了時間: 12:00
   - 定員: 20
   - 備考: 初心者向けクラス（任意）

3. **登録ボタンをクリック**
   - 「登録する」ボタンをクリック
   - 練習枠一覧ページにリダイレクトされることを確認

4. **登録された練習枠が表示されることを確認**
   - 練習枠一覧に、登録した練習枠が表示される
   - ステータスが「受付中」になっていることを確認

---

### 5-4. 練習枠編集の確認

**手順**:

1. **練習枠編集ページにアクセス**
   - 練習枠一覧で「編集」ボタンをクリック
   - または `http://localhost:3000/admin/practice-slots/[id]/edit` に直接アクセス（`[id]`は実際のID）

2. **フォームの値を変更**
   - 定員を変更（例: 20 → 25）
   - ステータスを変更（例: 受付中 → 受付終了）

3. **更新ボタンをクリック**
   - 「更新する」ボタンをクリック
   - 練習枠一覧ページにリダイレクトされることを確認

4. **変更が反映されていることを確認**
   - 練習枠一覧で、変更した値が反映されていることを確認

---

### 5-5. 練習枠削除の確認

**手順**:

1. **削除ボタンをクリック**
   - 練習枠一覧で「削除」ボタンをクリック

2. **確認ダイアログが表示されることを確認**
   - 「この練習枠を削除しますか？関連する予約も削除されます。」というメッセージが表示される

3. **削除を実行**
   - 「OK」をクリック
   - 練習枠が削除され、一覧から消えることを確認

---

## ✅ 完了チェックリスト

以下の項目を確認して、すべて完了したら時間予約機能（1）が完了です！

- [ ] APIエンドポイントが実装されている（GET, POST, PUT, DELETE）
- [ ] 練習枠一覧ページが表示される
- [ ] 練習枠登録ページが表示される
- [ ] 練習枠編集ページが表示される
- [ ] 練習枠を登録できる
- [ ] 練習枠を編集できる
- [ ] 練習枠を削除できる
- [ ] バリデーションが正しく動作する（必須項目、定員、時間形式など）
- [ ] エラーメッセージが正しく表示される
- [ ] 動作確認が完了している

---

## 📝 次のステップ

次回（2/16）の作業内容：
- 会員向け予約一覧表示
- 会員向け予約機能

詳細は `開発スケジュール.md` を参照してください。

---

## ⚠️ トラブルシューティング

### エラー1: 練習枠一覧が取得できない

**エラーメッセージ例**:
```
練習枠一覧の取得に失敗しました
```

**原因**: データベースの`practice_slots`テーブルが存在しない、またはAPIエンドポイントが正しく実装されていない。

**解決方法**:

1. **データベーステーブルを確認**
   - Supabaseのダッシュボードで`practice_slots`テーブルが存在するか確認
   - Prismaスキーマを確認して、マイグレーションが実行されているか確認

2. **APIエンドポイントを確認**
   - `frontend/app/api/practice-slots/route.ts`が正しく実装されているか確認
   - ブラウザの開発者ツールでネットワークタブを確認し、APIリクエストが正しく送信されているか確認

---

### エラー2: 練習枠の登録が失敗する

**エラーメッセージ例**:
```
練習枠の保存に失敗しました
```

**原因**: バリデーションエラー、またはデータベースエラー。

**解決方法**:

1. **バリデーションを確認**
   - 必須項目がすべて入力されているか確認
   - 定員が1以上の数値か確認
   - 時間がHH:MM形式か確認
   - 終了時間が開始時間より後か確認

2. **エラーログを確認**
   - ターミナルに表示されるエラーメッセージを確認
   - ブラウザの開発者ツールのコンソールを確認

---

### エラー3: 練習枠の編集ページが表示されない

**エラーメッセージ例**:
```
練習枠が見つかりません
```

**原因**: 練習枠IDが正しくない、またはデータベースに該当する練習枠が存在しない。

**解決方法**:

1. **練習枠IDを確認**
   - URLの`[id]`部分が正しいか確認
   - 練習枠一覧ページで、編集ボタンのリンクが正しいか確認

2. **データベースを確認**
   - Supabaseのダッシュボードで、該当する練習枠が存在するか確認

---

### エラー4: 削除が失敗する

**エラーメッセージ例**:
```
練習枠の削除に失敗しました
```

**原因**: データベースエラー、または外部キー制約エラー。

**解決方法**:

1. **外部キー制約を確認**
   - 削除しようとしている練習枠に関連する予約が存在する場合、カスケード削除が設定されているか確認
   - Prismaスキーマで`onDelete: Cascade`が設定されているか確認

2. **エラーログを確認**
   - ターミナルに表示されるエラーメッセージを確認
   - データベースのエラーメッセージを確認

---

## 💡 よくある質問（FAQ）

### Q1: 練習枠のステータスは自動的に更新されますか？

**A**: 現在の実装では、ステータスは手動で変更する必要があります。予約が追加・削除された際に自動的にステータスを更新する機能は、次回（2/16）の予約機能実装時に追加予定です。

---

### Q2: 同じ日時に複数の練習枠を登録できますか？

**A**: 現在の実装では、同じ日時に複数の練習枠を登録できます。重複チェックは実装していませんが、必要に応じて追加できます。

---

### Q3: 練習枠を削除すると、関連する予約も削除されますか？

**A**: はい。Prismaスキーマで`onDelete: Cascade`が設定されているため、練習枠を削除すると、関連する予約も自動的に削除されます。

---

### Q4: 定員を変更すると、現在の予約数が定員を超える可能性はありますか？

**A**: 現在の実装では、定員を変更する際に現在の予約数との整合性チェックは行っていません。必要に応じて、定員を現在の予約数より小さくできないようにするバリデーションを追加できます。

---

### Q5: 練習枠の一覧を日付順に並び替えることはできますか？

**A**: はい。APIエンドポイントで`.order('date', { ascending: true })`を使用しているため、日付順（昇順）に並び替えられています。降順にしたい場合は、`ascending: false`に変更してください。

---

## 📞 参考リンク

- **Next.js公式ドキュメント**: https://nextjs.org/docs
- **Supabase公式ドキュメント**: https://supabase.com/docs
- **Prisma公式ドキュメント**: https://www.prisma.io/docs
- **TypeScript公式ドキュメント**: https://www.typescriptlang.org/docs

---

**最終更新**: 2026年2月15日  
**対象**: プログラミング初心者の方
