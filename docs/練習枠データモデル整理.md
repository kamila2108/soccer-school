# 練習枠データモデル整理

## 📋 概要

時間予約機能で使用する練習枠のデータモデルを整理したドキュメントです。

---

## 📊 データモデル構造

### practice_slots テーブル

| カラム名 | データ型 | 説明 | 制約 |
|---------|---------|------|------|
| `id` | uuid | 練習枠ID | 主キー、自動生成 |
| `date` | DateTime | 練習日 | 必須 |
| `start_time` | String | 開始時間 | 必須（HH:MM形式） |
| `end_time` | String | 終了時間 | 必須（HH:MM形式） |
| `capacity` | Int | 定員 | 必須 |
| `current_bookings` | Int | 現在の予約数 | デフォルト0 |
| `status` | SlotStatus | ステータス | 必須（OPEN/FULL/CLOSED/CANCELLED） |
| `notes` | String? | 備考 | 任意 |
| `created_at` | DateTime | 作成日時 | 自動設定 |
| `updated_at` | DateTime | 更新日時 | 自動更新 |

---

## 📝 ステータスの説明

### SlotStatus 列挙型

- **OPEN**: 受付中
  - 予約を受け付けている状態
  - `current_bookings < capacity` の場合

- **FULL**: 満席
  - 定員に達している状態
  - `current_bookings >= capacity` の場合

- **CLOSED**: 受付終了
  - 管理者が手動で受付を終了した状態
  - 予約は受け付けない

- **CANCELLED**: 中止
  - 練習が中止になった状態
  - 予約は受け付けない

---

## 🔗 リレーション

### practice_slots と reservations の関係

- **1対多**: 1つの練習枠に対して、複数の予約が存在可能
- **外部キー**: `reservations.practice_slot_id` → `practice_slots.id`
- **カスケード削除**: 練習枠が削除されると、関連する予約も削除される

---

## 💡 使用例

### 練習枠の作成

```typescript
const newSlot: CreatePracticeSlotInput = {
  date: '2026-02-20',
  startTime: '10:00',
  endTime: '12:00',
  capacity: 20,
  notes: '初心者向けクラス',
}
```

### 練習枠の取得

```typescript
// 特定の日付の練習枠を取得
const slots = await supabase
  .from('practice_slots')
  .select('*')
  .eq('date', '2026-02-20')
  .eq('status', 'OPEN')
```

### 予約可能かどうかの判定

```typescript
import { isSlotAvailable } from '@/types/practice-slot'

if (isSlotAvailable(slot)) {
  // 予約可能
}
```

---

## 📅 日付・時間の形式

### 日付形式
- **データベース**: `DateTime`型（ISO 8601形式）
- **表示**: `YYYY年MM月DD日（曜日）`形式
- **入力**: `YYYY-MM-DD`形式

### 時間形式
- **データベース**: `String`型
- **表示・入力**: `HH:MM`形式（24時間表記）
- **例**: `10:00`, `14:30`, `18:00`

---

## 🔄 ステータスの自動更新

### 満席判定

練習枠のステータスは、予約が追加・削除された際に自動的に更新される必要があります：

```typescript
// 予約追加時
if (currentBookings >= capacity) {
  status = 'FULL'
}

// 予約削除時
if (currentBookings < capacity && status === 'FULL') {
  status = 'OPEN'
}
```

---

## 📌 注意事項

1. **日付の扱い**
   - 日付は`DateTime`型で保存されますが、時刻部分は無視されます
   - 表示時は日付のみを表示します

2. **時間の扱い**
   - 開始時間と終了時間は`String`型で保存します
   - `HH:MM`形式で統一します

3. **定員の管理**
   - `current_bookings`は予約が追加・削除されるたびに更新する必要があります
   - トランザクションを使用して、整合性を保つ必要があります

4. **ステータスの管理**
   - `OPEN`と`FULL`は自動的に切り替わります
   - `CLOSED`と`CANCELLED`は管理者が手動で設定します

---

## 🎯 次のステップ

- 練習枠一覧ページの実装
- 練習枠作成・編集機能の実装
- 予約機能の実装

---

**最終更新**: 2026年2月14日
